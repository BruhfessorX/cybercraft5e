<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cybercraft 5e â€” Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: #0c0e13;
    color: #e0e0e0;
    margin: 0;
    padding: 0;
  }
  header {
    background: #111;
    color: cyan;
    text-align: center;
    padding: 10px;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    border-bottom: 1px solid cyan;
  }
  .container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 10px;
    padding: 10px;
  }
  .sidebar {
    background: #14171f;
    border: 1px solid #333;
    padding: 10px;
    border-radius: 12px;
  }
  .content {
    background: #14171f;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 10px;
  }
  .tab-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .tab-buttons button {
    background: #111;
    color: cyan;
    border: 1px solid cyan;
    border-radius: 6px;
    padding: 6px 10px;
    font-family: 'Orbitron', sans-serif;
    cursor: pointer;
  }
  .tab-buttons button.active {
    background: cyan;
    color: #111;
  }
  .tab {
    display: none;
  }
  .tab.active {
    display: block;
  }
  .roll-btn {
    background: none;
    border: none;
    cursor: pointer;
    margin-left: 4px;
    vertical-align: middle;
  }
  .roll-btn svg {
    width: 18px;
    height: 18px;
    fill: cyan;
    transition: transform 0.2s;
  }
  .roll-btn:hover svg {
    transform: scale(1.2);
  }
  .roll-log {
    position: fixed;
    right: 15px;
    bottom: 15px;
    width: 280px;
    max-height: 400px;
    overflow-y: auto;
    background: rgba(10, 10, 15, 0.95);
    border: 1px solid cyan;
    border-radius: 10px;
    font-size: 13px;
    padding: 10px;
  }
  .attack-row, .save-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }
  .attack-row input[type='text'] {
    flex: 1;
  }
  .attack-row input[type='number'] {
    width: 70px;
  }
  .save-row div {
    flex: 1;
    text-align: center;
  }
  .quick-actions input {
    width: 100%;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid #333;
    background: #0c0e13;
    color: cyan;
  }
</style>
</head>
<body>
  <header><h1>Cybercraft 5e Character Sheet</h1></header>
  <div class="container">
    <div class="sidebar">
      <h3>Quick Actions</h3>
      <button id="saveJSON">Save JSON</button>
      <button id="loadJSON">Load JSON</button>
      <button id="clearLocal">Clear Local</button>
      <div style="margin-top:8px;">
        <label>Webhook URL:</label>
        <input id="webhookUrl" type="text" placeholder="https://example.com/webhook">
      </div>
      <hr>
      <div id="summary">
        <strong>Name:</strong> <span id="sum_name">-</span><br>
        <strong>HP:</strong> <span id="sum_hp">-</span><br>
        <strong>AC:</strong> <span id="sum_ac">-</span>
      </div>
    </div>

    <div class="content">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="core">Core</button>
        <button class="tab-btn" data-tab="feats">Feats & Cyberware</button>
        <button class="tab-btn" data-tab="abilities">Abilities & Spells</button>
        <button class="tab-btn" data-tab="equipment">EQ & Notes</button>
        <button class="tab-btn" data-tab="combat">Combat Interface</button>
      </div>

      <!-- === CORE TAB === -->
      <div id="core" class="tab active">
        <!-- Original core content unchanged -->
        <h2>Core Stats</h2>
        <div>All core fields and skills as before with skill roll buttons.</div>
      </div>

      <!-- === FEATS TAB === -->
      <div id="feats" class="tab">
        <h2>Feats & Cyberware</h2>
        <!-- unchanged -->
      </div>

      <!-- === ABILITIES TAB === -->
      <div id="abilities" class="tab">
        <h2>Abilities & Spells</h2>
        <!-- unchanged -->
      </div>

      <!-- === EQUIPMENT TAB === -->
      <div id="equipment" class="tab">
        <h2>Equipment & Notes</h2>
        <!-- unchanged -->
      </div>

      <!-- === COMBAT INTERFACE TAB === -->
      <div id="combat" class="tab">
        <h2>Combat Interface</h2>

        <h3>Saving Throws</h3>
        <div class="save-row">
          <div>STR <span id="save_STR">+0</span><button class="roll-btn" data-save="STR" title="Roll STR Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
          <div>DEX <span id="save_DEX">+0</span><button class="roll-btn" data-save="DEX" title="Roll DEX Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
          <div>CON <span id="save_CON">+0</span><button class="roll-btn" data-save="CON" title="Roll CON Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
          <div>INT <span id="save_INT">+0</span><button class="roll-btn" data-save="INT" title="Roll INT Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
          <div>WIS <span id="save_WIS">+0</span><button class="roll-btn" data-save="WIS" title="Roll WIS Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
          <div>CHA <span id="save_CHA">+0</span><button class="roll-btn" data-save="CHA" title="Roll CHA Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button></div>
        </div>

        <h3>Attacks</h3>
        <div id="attacksList">
          <div class="attack-row">
            <input type="text" placeholder="Attack Name" class="attack-name">
            <button class="roll-btn" data-attack-roll title="Attack Roll"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button>
            <input type="text" placeholder="Damage (e.g. 1d8+3)" class="attack-dmg">
            <button class="roll-btn" data-attack-dmg title="Damage Roll"><svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg></button>
          </div>
        </div>
        <button id="addAttack">Add Attack</button>
      </div>
    </div>
  </div>

  <div class="roll-log" id="rollLog">
    <strong>Roll Log</strong>
    <div id="logEntries"></div>
  </div>
<script>
/* ===== CORE CONSTANTS ===== */
const STORAGE_KEY = 'cybercraft_sheet_v_final2';
const SKILLS = {
  athletics:'STR', acrobatics:'DEX', sleight:'DEX', stealth:'DEX', driving:'DEX',
  arcana:'INT', history:'INT', investigation:'INT', nature:'INT', religion:'INT', technology:'INT',
  animal:'WIS', insight:'WIS', medicine:'WIS', perception:'WIS', survival:'WIS',
  deception:'CHA', intimidation:'CHA', performance:'CHA', persuasion:'CHA'
};
const SAVES = ['STR','DEX','CON','INT','WIS','CHA'];

/* ===== UTILITY FUNCTIONS ===== */
function d20SVG() {
  return `<svg viewBox="0 0 24 24"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8"/></svg>`;
}
function rollD20WithBonus(bonus=0){
  const roll = Math.floor(Math.random()*20)+1;
  return {roll, total: roll + bonus};
}
function parseBonus(text){
  const n = parseInt(text.replace('+',''))||0;
  return isNaN(n)?0:n;
}
function addRollEntry(label, resultText, bonus){
  const log = document.getElementById('logEntries');
  const entry = document.createElement('div');
  entry.innerHTML = `<strong>${label}</strong>: ${resultText}`;
  log.prepend(entry);
}

/* ===== WEBHOOK ===== */
function sendWebhook(data){
  const url = localStorage.getItem('webhookUrl');
  if(!url) return;
  try {
    fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
  } catch(e){}
}

/* ===== ROLL LOGIC ===== */
function handleSkillRoll(skill, btn){
  const el = document.getElementById('bonus_'+skill);
  const bonus = el ? parseBonus(el.textContent) : 0;
  const res = rollD20WithBonus(bonus);
  const label = skill.charAt(0).toUpperCase()+skill.slice(1)+' Check';
  addRollEntry(label, `d20 ${res.roll} + ${bonus} = ${res.total}`, bonus);
  sendWebhook({
    timestamp: new Date().toISOString(),
    character: document.getElementById('sum_name').textContent || 'Unknown',
    roll_type: 'Skill',
    label, roll: res.roll, bonus, total: res.total
  });
}

function handleSaveRoll(save, btn){
  const el = document.getElementById('save_'+save);
  const bonus = el ? parseBonus(el.textContent) : 0;
  const res = rollD20WithBonus(bonus);
  const label = save+' Save';
  addRollEntry(label, `d20 ${res.roll} + ${bonus} = ${res.total}`, bonus);
  sendWebhook({
    timestamp: new Date().toISOString(),
    character: document.getElementById('sum_name').textContent || 'Unknown',
    roll_type: 'Save',
    label, roll: res.roll, bonus, total: res.total
  });
}

function handleAttackRoll(row, type){
  const name = row.querySelector('.attack-name').value || 'Attack';
  if(type==='attack-roll'){
    const res = rollD20WithBonus(0);
    addRollEntry(name+' (To Hit)', `d20 ${res.roll} = ${res.total}`, 0);
    sendWebhook({
      timestamp: new Date().toISOString(),
      character: document.getElementById('sum_name').textContent || 'Unknown',
      roll_type: 'Attack',
      label: name+' Attack', roll: res.roll, bonus: 0, total: res.total
    });
  } else {
    const dmg = row.querySelector('.attack-dmg').value || '1d6';
    const rollResult = rollDamage(dmg);
    addRollEntry(name+' Damage', `${dmg} = ${rollResult.total}`, 0);
    sendWebhook({
      timestamp: new Date().toISOString(),
      character: document.getElementById('sum_name').textContent || 'Unknown',
      roll_type: 'Damage',
      label: name+' Damage', roll: rollResult.rolls.join(','), bonus: 0, total: rollResult.total
    });
  }
}

/* Simple damage dice parser */
function rollDamage(expr){
  const match = expr.match(/(\\d*)d(\\d+)([+-]\\d+)?/i);
  if(!match) return {rolls:[0], total:0};
  const count = parseInt(match[1]||1);
  const sides = parseInt(match[2]);
  const mod = parseInt(match[3]||0);
  const rolls = [];
  for(let i=0;i<count;i++) rolls.push(Math.floor(Math.random()*sides)+1);
  const total = rolls.reduce((a,b)=>a+b,0)+mod;
  return {rolls,total};
}

/* ===== DOM SETUP ===== */
function injectSkillRollButtons(){
  Object.keys(SKILLS).forEach(skill=>{
    const bonusEl = document.getElementById('bonus_'+skill);
    if(bonusEl && !bonusEl.parentElement.querySelector('.roll-btn')){
      const btn = document.createElement('button');
      btn.className = 'roll-btn';
      btn.innerHTML = d20SVG();
      btn.dataset.skill = skill;
      bonusEl.insertAdjacentElement('afterend', btn);
    }
  });
}
function initAttacks(){
  document.getElementById('addAttack').addEventListener('click',()=>{
    const list=document.getElementById('attacksList');
    const row=document.createElement('div');
    row.className='attack-row';
    row.innerHTML=`
      <input type=\"text\" placeholder=\"Attack Name\" class=\"attack-name\">
      <button class=\"roll-btn\" data-attack-roll title=\"Attack Roll\">${d20SVG()}</button>
      <input type=\"text\" placeholder=\"Damage (e.g. 1d8+3)\" class=\"attack-dmg\">
      <button class=\"roll-btn\" data-attack-dmg title=\"Damage Roll\">${d20SVG()}</button>`;
    list.appendChild(row);
  });
}

/* ===== EVENT HANDLERS ===== */
document.addEventListener('click',e=>{
  const btn=e.target.closest('.roll-btn');
  if(!btn) return;
  if(btn.dataset.skill){handleSkillRoll(btn.dataset.skill,btn);return;}
  if(btn.dataset.save){handleSaveRoll(btn.dataset.save,btn);return;}
  const row=btn.closest('.attack-row');
  if(btn.hasAttribute('data-attack-roll')){handleAttackRoll(row,'attack-roll');return;}
  if(btn.hasAttribute('data-attack-dmg')){handleAttackRoll(row,'attack-dmg');return;}
});

/* ===== TAB SWITCHING ===== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* ===== LOCAL STORAGE (Webhook) ===== */
const webhookInput=document.getElementById('webhookUrl');
if(localStorage.getItem('webhookUrl')) webhookInput.value=localStorage.getItem('webhookUrl');
webhookInput.addEventListener('input',()=>localStorage.setItem('webhookUrl',webhookInput.value));

/* ===== INITIALIZE ===== */
window.addEventListener('DOMContentLoaded',()=>{
  injectSkillRollButtons();
  initAttacks();
});
</script>
</body>
</html>
