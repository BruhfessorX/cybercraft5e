<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cybercraft 5e â€” Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0e0e10;
    --panel:#1a1a1c;
    --input:#262628;
    --neon:#9B30FF; /* site neon violet */
    --muted:#c6cad2;
    --accent-glow: 0 0 12px rgba(155,48,255,0.5);
    --field-border: rgba(155,48,255,0.06);
  }
  html,body {
    height:100%; margin:0; background:
      radial-gradient(900px 400px at 10% 8%, rgba(155,48,255,0.02), transparent),
      linear-gradient(180deg,#080809 0%,var(--bg) 50%);
    color:var(--muted); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container { max-width:1120px; margin:28px auto; padding:22px; }
  .titlebar{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--neon), #5b0fbf);border-radius:10px;box-shadow:var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:Orbitron;color:#050005;font-weight:700}
  .title-text h1{margin:0;font-family:Orbitron;color:var(--neon);font-size:20px}
  .title-text p{margin:0;font-size:12px;color:#aeb5c3}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}

  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  .tab.active{background:rgba(155,48,255,0.18);color:#fff;box-shadow:var(--accent-glow);transform:translateY(-2px)}

  .panel{background:var(--panel);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.05)}
  .card{background:rgba(255,255,255,0.02);border:1px solid var(--field-border);border-radius:10px;padding:12px;margin-bottom:12px}
  .card h3{margin:0 0 8px;color:var(--neon);font-family:Orbitron;font-size:13px}
  label{font-size:13px;color:#bfc5cf;min-width:120px}

  input[type="text"], input[type="number"], select, textarea {
    width:100%; padding:8px 10px; background:var(--input); border-radius:7px; border:1px solid rgba(0,0,0,0.3); color:var(--muted); outline:none; font-size:13px;
  }
  input:focus, textarea:focus, select:focus { box-shadow:var(--accent-glow); border-color:var(--neon); color:#fff; background:#1f1f20 }
  textarea{min-height:80px;resize:vertical}

  .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .row .small{width:120px}
  .list-wrap{max-height:240px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(155,48,255,0.04);background:rgba(255,255,255,0.005)}
  .list-item{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .list-item input, .list-item textarea{background:#1a1b1d}
  .btn { background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer }
  .btn.primary{background:linear-gradient(90deg,var(--neon),#5b0fbf);color:white;box-shadow:var(--accent-glow);border:none}

  /* Roll button (neon hex/d20 glyph) */
  .roll-btn {
    background:none;border:none;cursor:pointer;margin-left:8px;width:22px;height:22px;padding:2px;
  }
  .roll-btn svg {
    width:18px;height:18px; stroke:var(--neon); fill:none; stroke-width:2; transition:transform .12s ease, filter .18s ease;
    filter: drop-shadow(0 0 6px rgba(155,48,255,0.45));
  }
  .roll-btn:hover svg{ transform:scale(1.1); filter:drop-shadow(0 0 12px rgba(155,48,255,0.65)); }
  .roll-btn:active svg{ animation:rollPulse .36s ease; }
  @keyframes rollPulse {
    0% { transform: scale(1); opacity:1; }
    50% { transform: scale(1.35); opacity:0.75; }
    100% { transform: scale(1); opacity:1; }
  }

  /* Roll log floating panel */
  .roll-history {
    position:fixed; bottom:14px; right:14px; width:320px; max-height:46vh; overflow:auto;
    background:rgba(12,12,14,0.95); border:1px solid rgba(155,48,255,0.22); border-radius:10px; padding:8px; z-index:2000;
    box-shadow:0 6px 30px rgba(0,0,0,0.6);
  }
  .roll-history h4 { margin:0 0 6px 0; color:var(--neon); font-family:Orbitron; font-size:12px; display:flex; align-items:center; gap:8px }
  .roll-history .entry { font-size:13px; padding:6px 4px; border-bottom:1px dashed rgba(255,255,255,0.02); color:#e6e6e6 }
  .roll-history .muted { color:#9aa0b5; font-size:12px }

  /* compact responsive tweaks */
  @media (max-width:980px){
    .container{padding:12px}
    .tabs{flex-wrap:wrap}
  }
  @media print {
    body{background:white;color:black}
    .tabs, .controls, .roll-history{display:none}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <div class="logo">CV</div>
      <div class="title-text">
        <h1>Cybercraft 5e</h1>
        <p>Interactive Character Sheet</p>
      </div>

      <div class="controls">
        <button id="exportBtn" class="btn">Export</button>
        <button id="importBtn" class="btn">Import</button>
        <button id="clearBtn" class="btn">Clear</button>
        <button id="printBtn" class="btn primary">Print</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Tabs">
      <div class="tab active" data-tab="core">Core</div>
      <div class="tab" data-tab="feats">Feats & Cyberware</div>
      <div class="tab" data-tab="abilities">Abilities & Spells</div>
      <div class="tab" data-tab="eq">EQ & Notes</div>
      <div class="tab" data-tab="combat">Combat Interface</div>
    </div>

    <div class="panel">
      <!-- CORE TAB -->
      <div class="tab-panel" id="tab-core">
        <div class="card">
          <h3>Identity</h3>
          <div class="row"><label class="small">Character Name</label><input id="name" type="text" placeholder="Character"></div>
          <div class="row"><label class="small">Class</label><input id="class_text" type="text" placeholder="Class"></div>
          <div class="row"><label class="small">Level</label><input id="level" type="number" min="1" value="1" style="width:80px"></div>
        </div>

        <div class="card">
          <h3>Webhook & Settings</h3>
          <div class="row"><label class="small">Discord Webhook URL</label><input id="webhook_url" type="text" placeholder="https://discord.com/api/webhooks/..." /></div>
          <div class="row"><label class="small">Enable Webhook</label>
            <select id="webhook_enabled" style="width:120px">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
            <div style="margin-left:auto;color:#9aa0b5;font-size:12px">Posts rolls to webhook when enabled</div>
          </div>
        </div>

        <div class="card">
          <h3>Skills (click icon to roll)</h3>
          <div class="list-wrap" id="skills_wrap">
            <div class="list-item row">
              <div style="flex:1"><strong>Perception</strong> <span id="skill_perception_display" class="muted">+0</span></div>
              <div style="display:flex;align-items:center">
                <input id="skill_perception" type="text" value="+0" style="width:84px">
                <button class="roll-btn" data-roll="Perception" title="Roll Perception">
                  <svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg>
                </button>
              </div>
            </div>

            <div class="list-item row">
              <div style="flex:1"><strong>Stealth</strong> <span id="skill_stealth_display" class="muted">+0</span></div>
              <div style="display:flex;align-items:center">
                <input id="skill_stealth" type="text" value="+0" style="width:84px">
                <button class="roll-btn" data-roll="Stealth" title="Roll Stealth">
                  <svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg>
                </button>
              </div>
            </div>

            <!-- More skills can be added by the user / prefilled in future -->
          </div>
        </div>
      </div>

      <!-- FEATS & CYBERWARE -->
      <div class="tab-panel" id="tab-feats" style="display:none">
        <div class="card">
          <h3>Feats</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_feat_name" placeholder="Feat name" />
            <button id="addFeat" class="btn">Add</button>
          </div>
          <div id="feats_list" class="list-wrap"></div>
        </div>

        <div class="card">
          <h3>Cyberware</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_cyber_name" placeholder="Cyberware name" />
            <button id="addCyber" class="btn">Add</button>
          </div>
          <div id="cyber_list" class="list-wrap"></div>
        </div>
      </div>

      <!-- ABILITIES & SPELLS -->
      <div class="tab-panel" id="tab-abilities" style="display:none">
        <div class="card">
          <h3>Abilities</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_ability_name" placeholder="Ability name" />
            <button id="addAbility" class="btn">Add</button>
          </div>
          <div id="abilities_list" class="list-wrap"></div>
        </div>

        <div class="card">
          <h3>Spells</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_spell_name" placeholder="Spell name" />
            <input id="new_spell_level" placeholder="Lv" style="width:68px" />
            <button id="addSpell" class="btn">Add</button>
          </div>
          <div id="spells_list" class="list-wrap"></div>
        </div>
      </div>

      <!-- EQ & NOTES -->
      <div class="tab-panel" id="tab-eq" style="display:none">
        <div class="card">
          <h3>Equipment</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_equip" placeholder="Item (single-line)" />
            <button id="addEquip" class="btn">Add</button>
          </div>
          <div id="equip_list" class="list-wrap"></div>
        </div>

        <div class="card">
          <h3>Vehicles</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="new_vehicle_name" placeholder="Vehicle name" />
            <button id="addVehicle" class="btn">Add</button>
          </div>
          <div id="vehicles_list" class="list-wrap"></div>
        </div>

        <div class="card">
          <h3>Notes</h3>
          <textarea id="notes" placeholder="Campaign notes..."></textarea>
        </div>
      </div>

      <!-- COMBAT INTERFACE -->
      <div class="tab-panel" id="tab-combat" style="display:none">
        <div class="card">
          <h3>Saving Throws</h3>
          <div class="list-wrap" style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>STR</strong> <span id="save_STR">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="STR Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>

            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>DEX</strong> <span id="save_DEX">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="DEX Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>

            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>CON</strong> <span id="save_CON">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="CON Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>

            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>INT</strong> <span id="save_INT">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="INT Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>

            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>WIS</strong> <span id="save_WIS">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="WIS Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>

            <div class="row" style="width:48%;min-width:260px;">
              <div style="flex:1"><strong>CHA</strong> <span id="save_CHA">+0</span></div>
              <div style="display:flex;align-items:center">
                <button class="roll-btn" data-roll="CHA Save"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Attacks</h3>
          <div id="attacks_list" class="list-wrap"></div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input id="new_attack_name" placeholder="Attack Name" style="flex:1" />
            <input id="new_attack_bonus" placeholder="+Hit" style="width:80px" />
            <input id="new_attack_dmg" placeholder="Damage e.g. 1d8+3" style="width:140px" />
            <button id="addAttack" class="btn">Add</button>
          </div>
        </div>

        <div class="card">
          <h3>Defenses & HP</h3>
          <div class="row"><label class="small">Armor Class (AC)</label><input id="ac" type="text" placeholder="AC"></div>
          <div class="row"><label class="small">Speed</label><input id="speed" type="text" placeholder="Speed"></div>
          <div class="row" style="align-items:center">
            <label class="small">HP</label>
            <input id="hp_cur" placeholder="Current" style="width:90px" />
            <input id="hp_max" placeholder="Max" style="width:90px" />
            <input id="hp_temp" placeholder="Temp" style="width:90px" />
          </div>
          <div class="row" style="align-items:center">
            <label class="small">Initiative</label>
            <input id="init" type="text" readonly style="width:90px" />
            <button class="roll-btn" data-roll="Initiative" title="Roll Initiative"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Roll History (floating) -->
  <div class="roll-history" id="roll_history">
    <h4>
      <svg viewBox="0 0 24 24" width="14" height="14" style="stroke:var(--neon);fill:none;stroke-width:2">
        <polygon points="12,2 22,9 18,22 6,22 2,9"/>
      </svg>
      Roll Log
      <button id="clear_roll_log" class="btn" style="margin-left:auto">Clear</button>
    </h4>
    <div id="roll_log"></div>
  </div>

<script>
/* -------------------------
   Helper & storage keys
   ------------------------- */
const STORAGE_KEY = 'cybercraft_sheet_v_final';
const WEBHOOK_KEY = 'cybercraft_webhook_url';
const WEBHOOK_ENABLE_KEY = 'cybercraft_webhook_enabled';

/* dice roller: supports NdM+K and simple constants */
function rollDiceFormula(expr){
  expr = (expr||'').trim();
  // simple full-expression evaluator for dice like "1d8+3" or "2d6+1d4+2"
  // split by + and - while preserving signs
  // support basic tokens like "NdM" and integers
  try {
    let tokens = expr.replace(/\s+/g,'').match(/[+-]?[^+-]+/g);
    if(!tokens) return {total:0, detail: expr};
    let total=0, details=[];
    for(const t of tokens){
      let sign = 1;
      let token = t;
      if(t[0] === '+'){ sign = 1; token = t.slice(1); }
      else if(t[0] === '-'){ sign = -1; token = t.slice(1); }
      const m = token.match(/^(\d*)d(\d+)$/i);
      if(m){
        const num = parseInt(m[1])||1;
        const sides = parseInt(m[2]);
        let sum=0;
        let rolls=[];
        for(let i=0;i<num;i++){
          const r = Math.floor(Math.random()*sides)+1;
          rolls.push(r);
          sum += r;
        }
        total += sign * sum;
        details.push((sign===-1?'-':'') + token + ' [' + rolls.join(',') + ']');
      } else {
        const val = parseInt(token)||0;
        total += sign * val;
        details.push((sign===-1?'-':'') + token);
      }
    }
    return { total, detail: details.join(' + ').replace(/\+\s*-/g,'- ') };
  } catch(e){
    return { total:0, detail:expr };
  }
}

/* simple d20 roll for checks (1d20 + modifier) */
function rollCheck(mod){
  const die = Math.floor(Math.random()*20)+1;
  return { die, total: die + (parseInt(mod)||0) };
}

/* -------------------------
   Roll log + webhook posting
   ------------------------- */
function addRollLogLine(text, muted){
  const log = document.getElementById('roll_log');
  const el = document.createElement('div');
  el.className = 'entry';
  if(muted) el.classList.add('muted');
  el.innerHTML = text;
  log.prepend(el);
}

/* webhook send */
async function postToWebhook(payload){
  const url = (localStorage.getItem(WEBHOOK_KEY) || '').trim();
  const enabled = (localStorage.getItem(WEBHOOK_ENABLE_KEY) || 'no') === 'yes';
  if(!enabled || !url) return {ok:false, msg:'webhook disabled or missing'};
  try {
    // Discord webhook compatible JSON (simple embed like)
    const body = JSON.stringify({
      username: payload.username || 'Cybercraft Bot',
      embeds: [{
        title: payload.title,
        description: payload.description,
        color: 0x9B30FF
      }]
    });
    const res = await fetch(url, { method:'POST', body, headers: {'Content-Type':'application/json'} });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return {ok:true};
  } catch(err){
    return {ok:false, msg: err.message};
  }
}

/* send roll (log + optional webhook) */
async function sendRoll(name, formulaDisplay, result){
  const char = document.getElementById('name').value || 'Unknown';
  const text = `<strong>${escapeHtml(name)}</strong> â€¢ <em>${escapeHtml(formulaDisplay)}</em> â†’ <span style="color:var(--neon)">[${result}]</span>`;
  addRollLogLine(`${escapeHtml(char)} â€” ${text}`);
  // webhook payload
  const payload = {
    username: 'Cybercraft Rolls',
    title: `${char} â€¢ ${name}`,
    description: `**${formulaDisplay}** â†’ **${result}**`
  };
  const resp = await postToWebhook(payload);
  if(resp.ok){
    addRollLogLine(`<span class="muted">Webhook posted âœ“</span>`, true);
  } else if(resp.msg && resp.msg !== 'webhook disabled or missing'){
    addRollLogLine(`<span class="muted">Webhook error: ${escapeHtml(resp.msg)}</span>`, true);
  }
}

/* -------------------------
   Event wiring: roll buttons, attacks, skills, saves, initiative
   ------------------------- */
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.roll-btn');
  if(!btn) return;
  const rollName = btn.dataset.roll || 'Roll';
  // handle specialized roll naming conventions
  if(/Initiative/i.test(rollName)){
    // initiative: use dex mod if set in Init input or compute from 'init_mod' input
    const initModInput = document.getElementById('init_mod');
    let mod = 0;
    if(initModInput) mod = parseInt(initModInput.value)||0;
    const res = rollCheck(mod);
    await sendRoll('Initiative', `1d20 + ${mod}`, res.total);
    document.getElementById('init').value = (res.total >= 0 ? '+' : '') + res.total;
    return;
  }

  // Attack or Damage: if the button's data-roll ends with 'Damage' we try to resolve the damage formula
  if(/Damage$/i.test(rollName)){
    // find the corresponding input (we expect the attack name included)
    const attackLabel = rollName.replace(/\s*Damage$/i,'').trim();
    // try to find matching attack in list
    const items = Array.from(document.querySelectorAll('#attacks_list .list-item'));
    for(const it of items){
      const label = (it.querySelector('.atk_name')||{textContent:''}).textContent.trim();
      if(label === attackLabel){
        const dmgInput = it.querySelector('.atk_dmg');
        const formula = dmgInput ? dmgInput.value.trim() : '';
        const out = rollDiceFormula(formula || '0');
        await sendRoll(attackLabel + ' â€” Damage', formula || '0', out.total);
        return;
      }
    }
    // fallback: just post 1d6
    const r = rollDiceFormula('1d6');
    await sendRoll(rollName, '1d6', r.total);
    return;
  }

  // Attack rolls (To Hit)
  if(/Attack$/i.test(rollName)){
    const attackLabel = rollName.replace(/\s*Attack$/i,'').trim();
    const items = Array.from(document.querySelectorAll('#attacks_list .list-item'));
    for(const it of items){
      const label = (it.querySelector('.atk_name')||{textContent:''}).textContent.trim();
      if(label === attackLabel){
        const bonusInput = it.querySelector('.atk_bonus');
        const mod = parseInt(bonusInput ? bonusInput.value.replace('+','') : 0) || 0;
        const res = rollCheck(mod);
        await sendRoll(attackLabel + ' â€” Attack', `1d20 + ${mod}`, res.total);
        return;
      }
    }
    const r = rollCheck(0);
    await sendRoll(rollName, '1d20 + 0', r.total);
    return;
  }

  // Saves & Skills etc: perform d20 + bonus if possible
  const simpleMatch = rollName.match(/(.+?)\s*$/);
  const name = simpleMatch ? simpleMatch[1] : rollName;
  // attempt to find an input named for the bonus
  // look for elements with id like save_<AB> or skill_<name> or inputs nearby
  let mod = 0;
  // check save inputs by id mapping
  const saveId = 'save_' + name.replace(/\s+/g,'_');
  const saveEl = document.getElementById(saveId);
  if(saveEl && saveEl.textContent){
    mod = parseInt(saveEl.textContent.replace('+','')) || 0;
    const res = rollCheck(mod);
    await sendRoll(name, `1d20 + ${mod}`, res.total);
    return;
  }
  // fallback: look for input with id equal to lowercased name (skill_perception etc)
  const lookupId = name.toLowerCase().replace(/\s+/g,'_');
  const skillEl = document.getElementById(lookupId);
  if(skillEl && skillEl.value){
    // try to parse +N
    const parsed = parseInt((skillEl.value||'').replace(/\D/g,'')) || 0;
    const res = rollCheck(parsed);
    await sendRoll(name, `1d20 + ${parsed}`, res.total);
    return;
  }
  // final fallback: 1d20 only
  const r = rollCheck(0);
  await sendRoll(name, '1d20', r.total);
});

/* -------------------------
   Attacks list add/remove rendering
   ------------------------- */
function renderAttacks(){
  const wrap = document.getElementById('attacks_list');
  wrap.innerHTML = '';
  const arr = (window._attacks || []);
  arr.forEach((a,idx) => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div style="flex:1">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="width:160px"><strong class="atk_name">${escapeHtml(a.name)}</strong></div>
          <input class="atk_bonus" value="${escapeHtml(a.bonus)}" style="width:70px" />
          <button class="roll-btn" data-roll="${escapeHtml(a.name)} Attack" title="Roll Attack"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
          <input class="atk_dmg" value="${escapeHtml(a.dmg)}" style="width:140px" />
          <button class="roll-btn" data-roll="${escapeHtml(a.name)} Damage" title="Roll Damage"><svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,22 6,22 2,9"/></svg></button>
        </div>
      </div>
      <div><button class="btn" data-remove-attack="${idx}">Remove</button></div>
    `;
    wrap.appendChild(item);
  });
}

document.getElementById('addAttack').addEventListener('click', () => {
  const n = document.getElementById('new_attack_name').value.trim();
  const b = document.getElementById('new_attack_bonus').value.trim();
  const d = document.getElementById('new_attack_dmg').value.trim();
  if(!n) return alert('Enter attack name');
  window._attacks = window._attacks || [];
  window._attacks.push({ name: n, bonus: b, dmg: d });
  renderAttacks();
  saveToStorage();
  document.getElementById('new_attack_name').value = '';
  document.getElementById('new_attack_bonus').value = '';
  document.getElementById('new_attack_dmg').value = '';
});

/* remove attack handler */
document.getElementById('attacks_list').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-remove-attack]');
  if(!btn) return;
  const idx = parseInt(btn.getAttribute('data-remove-attack'));
  if(!isNaN(idx) && window._attacks && window._attacks[idx]){
    window._attacks.splice(idx,1);
    renderAttacks();
    saveToStorage();
  }
});

/* -------------------------
   Feats, Cyber, Abilities, Spells, Equip, Vehicles
   Generic lists (simple)
   ------------------------- */
function renderList(containerId, arr, renderItem){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  (arr||[]).forEach((it,i)=>{
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = renderItem(it,i);
    wrap.appendChild(div);
  });
}

/* feats */
window._feats = window._feats || [];
function renderFeats(){ renderList('feats_list', window._feats, (f,i)=>`
  <div style="flex:1">
    <input class="feat_name" data-i="${i}" value="${escapeHtml(f.name||'')}" placeholder="Feat name"/>
    <textarea class="feat_desc" data-i="${i}" placeholder="Description">${escapeHtml(f.desc||'')}</textarea>
  </div>
  <div><button class="btn" data-remove-feat="${i}">Remove</button></div>
`); }
document.getElementById('addFeat').addEventListener('click', ()=>{
  const name = document.getElementById('new_feat_name').value.trim(); if(!name) return alert('Enter feat name');
  window._feats.push({name:name,desc:''}); document.getElementById('new_feat_name').value=''; renderFeats(); saveToStorage();
});
document.getElementById('feats_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-feat]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-feat')); window._feats.splice(i,1); renderFeats(); saveToStorage();
});

/* cyberware */
window._cyber = window._cyber || [];
function renderCyber(){ renderList('cyber_list', window._cyber, (c,i)=>`
  <div style="flex:1">
    <input class="cyber_name" data-i="${i}" value="${escapeHtml(c.name||'')}" placeholder="Cyberware name"/>
    <textarea class="cyber_desc" data-i="${i}" placeholder="Description">${escapeHtml(c.desc||'')}</textarea>
  </div>
  <div><button class="btn" data-remove-cyber="${i}">Remove</button></div>
`); }
document.getElementById('addCyber').addEventListener('click', ()=>{
  const name = document.getElementById('new_cyber_name').value.trim(); if(!name) return alert('Enter cyberware name');
  window._cyber.push({name:name,desc:''}); document.getElementById('new_cyber_name').value=''; renderCyber(); saveToStorage();
});
document.getElementById('cyber_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-cyber]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-cyber')); window._cyber.splice(i,1); renderCyber(); saveToStorage();
});

/* abilities */
window._abilities = window._abilities || [];
function renderAbilities(){ renderList('abilities_list', window._abilities, (a,i)=>`
  <div style="flex:1">
    <input class="ability_name" data-i="${i}" value="${escapeHtml(a.name||'')}" placeholder="Ability name"/>
    <textarea class="ability_desc" data-i="${i}" placeholder="Description">${escapeHtml(a.desc||'')}</textarea>
  </div>
  <div><button class="btn" data-remove-ability="${i}">Remove</button></div>
`); }
document.getElementById('addAbility').addEventListener('click', ()=>{
  const name = document.getElementById('new_ability_name').value.trim(); if(!name) return alert('Enter ability name');
  window._abilities.push({name:name,desc:''}); document.getElementById('new_ability_name').value=''; renderAbilities(); saveToStorage();
});
document.getElementById('abilities_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-ability]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-ability')); window._abilities.splice(i,1); renderAbilities(); saveToStorage();
});

/* spells */
window._spells = window._spells || [];
function renderSpells(){ renderList('spells_list', window._spells, (s,i)=>`
  <div style="flex:1">
    <input class="spell_name" data-i="${i}" value="${escapeHtml(s.name||'')}" placeholder="Spell name"/>
    <input class="spell_level" data-i="${i}" value="${escapeHtml(s.level||'')}" style="width:68px"/>
    <textarea class="spell_desc" data-i="${i}" placeholder="Details">${escapeHtml(s.desc||'')}</textarea>
  </div>
  <div><button class="btn" data-remove-spell="${i}">Remove</button></div>
`); }
document.getElementById('addSpell').addEventListener('click', ()=>{
  const name = document.getElementById('new_spell_name').value.trim(); const lvl = document.getElementById('new_spell_level').value.trim();
  if(!name) return alert('Enter spell name'); window._spells.push({name:name,level:lvl,desc:''}); document.getElementById('new_spell_name').value=''; document.getElementById('new_spell_level').value=''; renderSpells(); saveToStorage();
});
document.getElementById('spells_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-spell]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-spell')); window._spells.splice(i,1); renderSpells(); saveToStorage();
});

/* equip */
window._equip = window._equip || [];
function renderEquip(){ renderList('equip_list', window._equip, (it,i)=>`
  <div style="flex:1"><input class="equip_item" data-i="${i}" value="${escapeHtml(it||'')}" placeholder="Item name"/></div>
  <div><button class="btn" data-remove-equip="${i}">Remove</button></div>
`); }
document.getElementById('addEquip').addEventListener('click', ()=>{
  const name = document.getElementById('new_equip').value.trim(); if(!name) return alert('Enter item'); window._equip.push(name); document.getElementById('new_equip').value=''; renderEquip(); saveToStorage();
});
document.getElementById('equip_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-equip]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-equip')); window._equip.splice(i,1); renderEquip(); saveToStorage();
});

/* vehicles */
window._vehicles = window._vehicles || [];
function renderVehicles(){ renderList('vehicles_list', window._vehicles, (v,i)=>`
  <div style="flex:1">
    <input class="veh_name" data-i="${i}" value="${escapeHtml(v.name||'')}" placeholder="Vehicle name"/>
    <input class="veh_type" data-i="${i}" value="${escapeHtml(v.type||'')}" placeholder="Type" style="width:120px"/>
    <input class="veh_speed" data-i="${i}" value="${escapeHtml(v.speed||'')}" placeholder="Speed" style="width:80px"/>
    <textarea class="veh_desc" data-i="${i}" placeholder="Notes">${escapeHtml(v.desc||'')}</textarea>
  </div>
  <div><button class="btn" data-remove-vehicle="${i}">Remove</button></div>
`); }
document.getElementById('addVehicle').addEventListener('click', ()=>{
  const name = document.getElementById('new_vehicle_name').value.trim(); if(!name) return alert('Enter vehicle name');
  window._vehicles.push({name:name,type:'',speed:'',desc:''}); document.getElementById('new_vehicle_name').value=''; renderVehicles(); saveToStorage();
});
document.getElementById('vehicles_list').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-remove-vehicle]'); if(!btn) return;
  const i = parseInt(btn.getAttribute('data-remove-vehicle')); window._vehicles.splice(i,1); renderVehicles(); saveToStorage();
});

/* -------------------------
   Export / Import / Clear / Print
   ------------------------- */
document.getElementById('exportBtn').addEventListener('click', () => {
  const raw = JSON.stringify(gatherState());
  const blob = new Blob([raw], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (document.getElementById('name').value || 'character') + '.cyber.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', () => {
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = (e) => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = () => {
      try { const parsed = JSON.parse(r.result); applyState(parsed); saveToStorage(); alert('Import OK'); } catch(err){ alert('Import failed: invalid file'); }
    }; r.readAsText(f);
  }; input.click();
});
document.getElementById('clearBtn').addEventListener('click', () => { if(confirm('Clear local sheet data? This cannot be undone.')){ localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(WEBHOOK_KEY); localStorage.removeItem(WEBHOOK_ENABLE_KEY); location.reload(); }});
document.getElementById('printBtn').addEventListener('click', ()=>window.print());

/* clear roll log */
document.getElementById('clear_roll_log').addEventListener('click', ()=>{ document.getElementById('roll_log').innerHTML = ''; });

/* -------------------------
   Save / load state
   ------------------------- */
function gatherState(){
  const state = {
    name: document.getElementById('name').value || '',
    class_text: document.getElementById('class_text').value || '',
    level: document.getElementById('level').value || '1',
    webhook_url: document.getElementById('webhook_url').value || '',
    webhook_enabled: document.getElementById('webhook_enabled').value || 'no',
    skills: {
      perception: document.getElementById('skill_perception').value || '+0',
      stealth: document.getElementById('skill_stealth').value || '+0'
    },
    saves: {
      STR: document.getElementById('save_STR').textContent || '+0',
      DEX: document.getElementById('save_DEX').textContent || '+0',
      CON: document.getElementById('save_CON').textContent || '+0',
      INT: document.getElementById('save_INT').textContent || '+0',
      WIS: document.getElementById('save_WIS').textContent || '+0',
      CHA: document.getElementById('save_CHA').textContent || '+0'
    },
    attacks: window._attacks || [],
    feats: window._feats || [],
    cyber: window._cyber || [],
    abilities: window._abilities || [],
    spells: window._spells || [],
    equip: window._equip || [],
    vehicles: window._vehicles || [],
    ac: document.getElementById('ac').value || '',
    speed: document.getElementById('speed').value || '',
    hp_cur: document.getElementById('hp_cur').value || '',
    hp_max: document.getElementById('hp_max').value || '',
    hp_temp: document.getElementById('hp_temp').value || ''
  };
  return state;
}

function applyState(state){
  if(!state) return;
  document.getElementById('name').value = state.name || '';
  document.getElementById('class_text').value = state.class_text || '';
  document.getElementById('level').value = state.level || '1';
  document.getElementById('webhook_url').value = state.webhook_url || '';
  document.getElementById('webhook_enabled').value = state.webhook_enabled || 'no';
  document.getElementById('skill_perception').value = (state.skills && state.skills.perception) || '+0';
  document.getElementById('skill_perception_display').textContent = (state.skills && state.skills.perception) || '+0';
  document.getElementById('skill_stealth').value = (state.skills && state.skills.stealth) || '+0';
  document.getElementById('skill_stealth_display').textContent = (state.skills && state.skills.stealth) || '+0';

  if(state.saves){
    document.getElementById('save_STR').textContent = state.saves.STR || '+0';
    document.getElementById('save_DEX').textContent = state.saves.DEX || '+0';
    document.getElementById('save_CON').textContent = state.saves.CON || '+0';
    document.getElementById('save_INT').textContent = state.saves.INT || '+0';
    document.getElementById('save_WIS').textContent = state.saves.WIS || '+0';
    document.getElementById('save_CHA').textContent = state.saves.CHA || '+0';
  }

  window._attacks = state.attacks || [];
  window._feats = state.feats || [];
  window._cyber = state.cyber || [];
  window._abilities = state.abilities || [];
  window._spells = state.spells || [];
  window._equip = state.equip || [];
  window._vehicles = state.vehicles || [];
  renderAttacks(); renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles();

  document.getElementById('ac').value = state.ac || '';
  document.getElementById('speed').value = state.speed || '';
  document.getElementById('hp_cur').value = state.hp_cur || '';
  document.getElementById('hp_max').value = state.hp_max || '';
  document.getElementById('hp_temp').value = state.hp_temp || '';
}

/* Save to localStorage automatically */
function saveToStorage(){
  try {
    const state = gatherState();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    localStorage.setItem(WEBHOOK_KEY, document.getElementById('webhook_url').value || '');
    localStorage.setItem(WEBHOOK_ENABLE_KEY, document.getElementById('webhook_enabled').value || 'no');
  } catch(e){ console.error(e); }
}

function loadFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    applyState(parsed);
    // webhook values possibly saved separately
    const wurl = localStorage.getItem(WEBHOOK_KEY) || '';
    const wenabled = localStorage.getItem(WEBHOOK_ENABLE_KEY) || 'no';
    if(wurl) document.getElementById('webhook_url').value = wurl;
    if(wenabled) document.getElementById('webhook_enabled').value = wenabled;
  } catch(e){ console.error(e); }
}

/* autosave listeners */
document.querySelectorAll('input,textarea,select').forEach(el=>{
  el.addEventListener('input', ()=>{ if(window._saveTimer) clearTimeout(window._saveTimer); window._saveTimer = setTimeout(()=>saveToStorage(), 450); });
});

/* -------------------------
   Tab handling
   ------------------------- */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
    const id = 'tab-' + tab.dataset.tab;
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
  });
});

/* -------------------------
   Utilities
   ------------------------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------------
   Boot: load state and wire lists
   ------------------------- */
loadFromStorage();
renderAttacks(); renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles();

/* attach remove handlers for lists that use delegation */
document.addEventListener('click', (e) => {
  // feats/cyber/abilities/spells/equip/vehicles remove delegated earlier using dataset selectors
  const removeFeat = e.target.closest('[data-remove-feat]');
  if(removeFeat){ const i = parseInt(removeFeat.getAttribute('data-remove-feat')); if(!isNaN(i)){ window._feats.splice(i,1); renderFeats(); saveToStorage(); } }
  const removeCyber = e.target.closest('[data-remove-cyber]');
  if(removeCyber){ const i = parseInt(removeCyber.getAttribute('data-remove-cyber')); if(!isNaN(i)){ window._cyber.splice(i,1); renderCyber(); saveToStorage(); } }
  const removeAbility = e.target.closest('[data-remove-ability]');
  if(removeAbility){ const i = parseInt(removeAbility.getAttribute('data-remove-ability')); if(!isNaN(i)){ window._abilities.splice(i,1); renderAbilities(); saveToStorage(); } }
  const removeSpell = e.target.closest('[data-remove-spell]');
  if(removeSpell){ const i = parseInt(removeSpell.getAttribute('data-remove-spell')); if(!isNaN(i)){ window._spells.splice(i,1); renderSpells(); saveToStorage(); } }
  const removeEquip = e.target.closest('[data-remove-equip]');
  if(removeEquip){ const i = parseInt(removeEquip.getAttribute('data-remove-equip')); if(!isNaN(i)){ window._equip.splice(i,1); renderEquip(); saveToStorage(); } }
  const removeVehicle = e.target.closest('[data-remove-vehicle]');
  if(removeVehicle){ const i = parseInt(removeVehicle.getAttribute('data-remove-vehicle')); if(!isNaN(i)){ window._vehicles.splice(i,1); renderVehicles(); saveToStorage(); } }
});

/* Keep inputs synced to display areas (simple binding for skill displays) */
document.getElementById('skill_perception').addEventListener('input', (e)=>{ document.getElementById('skill_perception_display').textContent = e.target.value; saveToStorage(); });
document.getElementById('skill_stealth').addEventListener('input', (e)=>{ document.getElementById('skill_stealth_display').textContent = e.target.value; saveToStorage(); });

/* Save webhook fields separately too */
document.getElementById('webhook_url').addEventListener('input', ()=>{ localStorage.setItem(WEBHOOK_KEY, document.getElementById('webhook_url').value || ''); });
document.getElementById('webhook_enabled').addEventListener('change', ()=>{ localStorage.setItem(WEBHOOK_ENABLE_KEY, document.getElementById('webhook_enabled').value || 'no'); });

/* small periodic save guard */
setInterval(saveToStorage, 5000);

</script>
</body>
</html>
