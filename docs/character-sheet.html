<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cybercraft Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0e10;
    --panel:#141416;
    --input:#1f1f21;
    --neon:#9B30FF; /* site neon violet */
    --muted:#c6cad2;
    --glass: rgba(255,255,255,0.02);
    --accent-glow: 0 0 18px rgba(155,48,255,0.22), inset 0 0 8px rgba(0,0,0,0.35);
    --field-border: rgba(155,48,255,0.06);
    --hex-size:36px;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(900px 420px at 10% 8%, rgba(155,48,255,0.02), transparent),
    linear-gradient(180deg,#080809 0%,var(--bg) 50%);color:var(--muted);
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .container{max-width:1140px;margin:28px auto;padding:22px;}

  /* Header */
  .header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--neon), #5b0fbf);border-radius:10px;box-shadow:var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:Orbitron;color:#050005;font-weight:700}
  .title-text h1{margin:0;font-family:Orbitron;color:var(--neon);font-size:20px;text-shadow:0 0 10px rgba(155,48,255,0.16)}
  .title-text p{margin:0;font-size:12px;color:#aeb5c3}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{padding:8px 12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:linear-gradient(180deg, rgba(155,48,255,0.06), rgba(155,48,255,0.02));box-shadow:var(--accent-glow);color:white;border:1px solid rgba(155,48,255,0.25);transform:translateY(-2px)}

  .panel{background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.03);padding:16px;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  .panel-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:980px){.panel-grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border-radius:10px;padding:12px;border:1px solid var(--field-border)}
  .card h3{margin:0 0 8px 0;color:var(--neon);font-family:Orbitron;font-size:13px}
  label{font-size:13px;color:#bfc5cf;min-width:120px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:8px 10px;background:var(--input);border-radius:7px;border:1px solid rgba(0,0,0,0.3);color:var(--muted);outline:none;font-size:13px;
  }
  input:focus, textarea:focus, select:focus{box-shadow:var(--accent-glow);border-color:var(--neon);color:#fff;background:#1f1f20}
  textarea{min-height:80px;resize:vertical}

  /* attributes */
  .attributes{display:flex;gap:10px;flex-wrap:wrap}
  .attr-box{width:82px;background:linear-gradient(180deg,rgba(0,0,0,0.12),transparent);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--field-border)}
  .attr-box .score{font-size:18px;color:#fff;font-weight:700}
  .attr-box .label{font-size:12px;color:#c6cad2;margin-top:6px}
  .save-row{font-size:12px;color:#c6cad2;margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px}

  /* skills */
  .skill-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .skill-row label{min-width:160px;color:#c6cad2}
  .checkbox-inline{display:flex;align-items:center;gap:6px;color:#bfc4cf;font-size:13px}
  .skill-bonus{min-width:48px;text-align:right;font-weight:700;color:#fff}

  .list-wrap{max-height:260px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(155,48,255,0.04);background:rgba(255,255,255,0.005)}
  .list-item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
  .list-item input, .list-item textarea{background:#1a1b1d}
  .list-item .remove{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:4px 8px;border-radius:6px;cursor:pointer}

  .btnbar{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--neon),#5b0fbf);color:white;box-shadow:var(--accent-glow);border:none}
  .muted{color:#9aa0b5;font-size:12px}

  .snapshot .row{justify-content:space-between}
  .snapshot strong{color:#fff}

  /* roll button (hex/d20) */
  .roll-btn {
    width:var(--hex-size);
    height:var(--hex-size);
    min-width:var(--hex-size);
    min-height:var(--hex-size);
    display:inline-flex;align-items:center;justify-content:center;
    border-radius:8px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
    border:1px solid rgba(255,255,255,0.04);
    cursor:pointer;
    box-shadow: 0 0 10px rgba(155,48,255,0.06);
    transition:transform 120ms ease, box-shadow 160ms ease;
  }
  .roll-btn:hover{transform:translateY(-2px);box-shadow:var(--accent-glow)}
  .roll-icon {
    width:18px;height:18px;fill:var(--neon);
    filter:drop-shadow(0 0 6px rgba(155,48,255,0.14));
  }
  /* ripple */
  .roll-btn.ripple::after{
    content:"";
    position:absolute;
    width:var(--hex-size);height:var(--hex-size);
    border-radius:50%;
    transform:scale(0);
    background: radial-gradient(circle at center, rgba(155,48,255,0.18), rgba(155,48,255,0.06));
    animation: ripple 700ms ease-out;
    pointer-events:none;
  }
  @keyframes ripple { to { transform:scale(2.2); opacity:0; } }

  /* roll log overlay */
  .roll-log {
    position:fixed; right:18px; bottom:18px; z-index:1200;
    font-size:13px;
  }
  .roll-tab {
    width:var(--hex-size); height:var(--hex-size);
    border-radius:8px; background:linear-gradient(135deg,var(--neon), #5b0fbf);
    box-shadow:var(--accent-glow); display:flex;align-items:center;justify-content:center;cursor:pointer;
  }
  .log-panel {
    width:360px; max-height:420px; overflow:auto; background:rgba(10,10,12,0.98);
    border:1px solid rgba(155,48,255,0.12); box-shadow:0 12px 40px rgba(0,0,0,0.6);
    border-radius:10px; padding:10px; margin-bottom:8px;
  }
  .log-item{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02);color:#e7e7ea}
  .log-item small{color:#b6b3be;display:block;margin-top:6px;font-size:11px}

  /* attacks layout (inline) */
  .attack-row{display:grid;grid-template-columns:1fr 80px 1fr 90px 44px;gap:8px;align-items:center;margin-bottom:8px}
  .attack-row input{padding:6px}
  .attack-row .attack-damage{display:flex;gap:6px}
  .attack-row .attack-damage input{width:62%}
  .attack-row .attack-damage input.type{width:38%}

  /* compact saves row */
  .saves-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .save-box{background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(155,48,255,0.03);display:flex;align-items:center;justify-content:space-between}

  /* small helpers */
  .muted-sm{font-size:12px;color:#9aa0b5}
  .flex-row{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .portrait{width:88px;height:88px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);overflow:hidden;display:flex;align-items:center;justify-content:center}
  .portrait img{width:100%;height:100%;object-fit:cover}

  @media print{
    body{background:white;color:black}
    .header, .tabs, .btnbar{display:none}
    input,textarea{border:1px solid #aaa;color:black;background:white}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">CV</div>
      <div class="title-text">
        <h1>Cybercraft Character Sheet</h1>
        <p>Interactive — local save / export</p>
      </div>

      <div class="controls">
        <button id="export">Export</button>
        <button id="importBtn">Import</button>
        <button id="clear">Clear</button>
        <button id="print" class="primary">Print</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="core">Core</div>
      <div class="tab" data-tab="feats">Feats & Cyberware</div>
      <div class="tab" data-tab="abilities">Abilities & Spells</div>
      <div class="tab" data-tab="eq">EQ & Notes</div>
      <div class="tab" data-tab="combat">Combat Interface</div> <!-- last tab on right -->
    </div>

    <div class="panel">
      <div class="panel-grid">

        <!-- LEFT MAIN -->
        <div>
          <!-- CORE TAB -->
          <div class="tab-panel" id="tab-core">
            <div class="card" style="display:flex;gap:12px;align-items:flex-start">
              <div style="flex:1">
                <h3>Identity</h3>
                <div class="row"><label>Character Name</label><input id="name" type="text"></div>
                <div class="row"><label>Player</label><input id="player" type="text"></div>
                <div class="row"><label>Race</label><input id="race" type="text"></div>
                <div class="row"><label>Class</label><input id="class_text" type="text"></div>
                <div class="row"><label>Level</label><input id="level" type="number" min="1" value="1"></div>
                <div class="row"><label>Background</label><input id="background" type="text"></div>
                <div class="row"><label>Faction</label><input id="faction" type="text"></div>
                <div class="row"><label>Alignment</label><input id="alignment" type="text"></div>
              </div>
              <div style="width:120px;text-align:center">
                <div class="portrait" id="portrait_wrap"><span class="muted-sm">No portrait</span></div>
                <div style="margin-top:8px">
                  <input id="portrait_file" type="file" accept="image/*">
                </div>
                <div style="margin-top:8px" class="muted-sm">Upload portrait</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attributes & Saving Throws</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="attr-box">
                  <div><input id="attr_STR" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">STR</div>
                  <div class="save-row"><input id="save_prof_STR" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_STR">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_DEX" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">DEX</div>
                  <div class="save-row"><input id="save_prof_DEX" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_DEX">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CON" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">CON</div>
                  <div class="save-row"><input id="save_prof_CON" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CON">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_INT" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">INT</div>
                  <div class="save-row"><input id="save_prof_INT" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_INT">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_WIS" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">WIS</div>
                  <div class="save-row"><input id="save_prof_WIS" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_WIS">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CHA" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" /></div>
                  <div class="label">CHA</div>
                  <div class="save-row"><input id="save_prof_CHA" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CHA">+0</div></div>
                </div>
              </div>
              <div class="muted-sm" style="margin-top:8px">Check Save Prof if your class grants proficiency in that save.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Skills</h3>
              <p class="muted">Toggle Proficiency / Expertise. Use the roll button to make skill checks.</p>
              <div style="margin-top:8px">
                <!-- List of skills including Driving and Technology -->
                <div class="skill-row"><label>Athletics (STR)</label><div class="checkbox-inline"><input id="prof_athletics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_athletics" type="checkbox">Exp</div><div class="skill-bonus" id="bonus_athletics">+0</div><button class="roll-btn" data-roll="skill:athletics" title="Roll Athletics"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Acrobatics (DEX)</label><div class="checkbox-inline"><input id="prof_acrobatics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_acrobatics" type="checkbox">Exp</div><div class="skill-bonus" id="bonus_acrobatics">+0</div><button class="roll-btn" data-roll="skill:acrobatics" title="Roll Acrobatics"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Sleight of Hand (DEX)</label><div class="checkbox-inline"><input id="prof_sleight" type="checkbox"></div><div class="checkbox-inline"><input id="exp_sleight" type="checkbox"></div><div class="skill-bonus" id="bonus_sleight">+0</div><button class="roll-btn" data-roll="skill:sleight" title="Roll Sleight"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Stealth (DEX)</label><div class="checkbox-inline"><input id="prof_stealth" type="checkbox"></div><div class="checkbox-inline"><input id="exp_stealth" type="checkbox"></div><div class="skill-bonus" id="bonus_stealth">+0</div><button class="roll-btn" data-roll="skill:stealth" title="Roll Stealth"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Driving (DEX)</label><div class="checkbox-inline"><input id="prof_driving" type="checkbox"></div><div class="checkbox-inline"><input id="exp_driving" type="checkbox"></div><div class="skill-bonus" id="bonus_driving">+0</div><button class="roll-btn" data-roll="skill:driving" title="Roll Driving"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Arcana (INT)</label><div class="checkbox-inline"><input id="prof_arcana" type="checkbox"></div><div class="checkbox-inline"><input id="exp_arcana" type="checkbox"></div><div class="skill-bonus" id="bonus_arcana">+0</div><button class="roll-btn" data-roll="skill:arcana" title="Roll Arcana"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>History (INT)</label><div class="checkbox-inline"><input id="prof_history" type="checkbox"></div><div class="checkbox-inline"><input id="exp_history" type="checkbox"></div><div class="skill-bonus" id="bonus_history">+0</div><button class="roll-btn" data-roll="skill:history" title="Roll History"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Investigation (INT)</label><div class="checkbox-inline"><input id="prof_investigation" type="checkbox"></div><div class="checkbox-inline"><input id="exp_investigation" type="checkbox"></div><div class="skill-bonus" id="bonus_investigation">+0</div><button class="roll-btn" data-roll="skill:investigation" title="Roll Investigation"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Nature (INT)</label><div class="checkbox-inline"><input id="prof_nature" type="checkbox"></div><div class="checkbox-inline"><input id="exp_nature" type="checkbox"></div><div class="skill-bonus" id="bonus_nature">+0</div><button class="roll-btn" data-roll="skill:nature" title="Roll Nature"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Religion (INT)</label><div class="checkbox-inline"><input id="prof_religion" type="checkbox"></div><div class="checkbox-inline"><input id="exp_religion" type="checkbox"></div><div class="skill-bonus" id="bonus_religion">+0</div><button class="roll-btn" data-roll="skill:religion" title="Roll Religion"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Technology (INT)</label><div class="checkbox-inline"><input id="prof_technology" type="checkbox"></div><div class="checkbox-inline"><input id="exp_technology" type="checkbox"></div><div class="skill-bonus" id="bonus_technology">+0</div><button class="roll-btn" data-roll="skill:technology" title="Roll Technology"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Animal Handling (WIS)</label><div class="checkbox-inline"><input id="prof_animal" type="checkbox"></div><div class="checkbox-inline"><input id="exp_animal" type="checkbox"></div><div class="skill-bonus" id="bonus_animal">+0</div><button class="roll-btn" data-roll="skill:animal" title="Roll Animal Handling"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Insight (WIS)</label><div class="checkbox-inline"><input id="prof_insight" type="checkbox"></div><div class="checkbox-inline"><input id="exp_insight" type="checkbox"></div><div class="skill-bonus" id="bonus_insight">+0</div><button class="roll-btn" data-roll="skill:insight" title="Roll Insight"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Medicine (WIS)</label><div class="checkbox-inline"><input id="prof_medicine" type="checkbox"></div><div class="checkbox-inline"><input id="exp_medicine" type="checkbox"></div><div class="skill-bonus" id="bonus_medicine">+0</div><button class="roll-btn" data-roll="skill:medicine" title="Roll Medicine"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Perception (WIS)</label><div class="checkbox-inline"><input id="prof_perception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_perception" type="checkbox"></div><div class="skill-bonus" id="bonus_perception">+0</div><button class="roll-btn" data-roll="skill:perception" title="Roll Perception"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Survival (WIS)</label><div class="checkbox-inline"><input id="prof_survival" type="checkbox"></div><div class="checkbox-inline"><input id="exp_survival" type="checkbox"></div><div class="skill-bonus" id="bonus_survival">+0</div><button class="roll-btn" data-roll="skill:survival" title="Roll Survival"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Deception (CHA)</label><div class="checkbox-inline"><input id="prof_deception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_deception" type="checkbox"></div><div class="skill-bonus" id="bonus_deception">+0</div><button class="roll-btn" data-roll="skill:deception" title="Roll Deception"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Intimidation (CHA)</label><div class="checkbox-inline"><input id="prof_intimidation" type="checkbox"></div><div class="checkbox-inline"><input id="exp_intimidation" type="checkbox"></div><div class="skill-bonus" id="bonus_intimidation">+0</div><button class="roll-btn" data-roll="skill:intimidation" title="Roll Intimidation"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Performance (CHA)</label><div class="checkbox-inline"><input id="prof_performance" type="checkbox"></div><div class="checkbox-inline"><input id="exp_performance" type="checkbox"></div><div class="skill-bonus" id="bonus_performance">+0</div><button class="roll-btn" data-roll="skill:performance" title="Roll Performance"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

                <div class="skill-row"><label>Persuasion (CHA)</label><div class="checkbox-inline"><input id="prof_persuasion" type="checkbox"></div><div class="checkbox-inline"><input id="exp_persuasion" type="checkbox"></div><div class="skill-bonus" id="bonus_persuasion">+0</div><button class="roll-btn" data-roll="skill:persuasion" title="Roll Persuasion"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>

              </div>
            </div>

          </div>

          <!-- FEATS & CYBERWARE TAB -->
          <div class="tab-panel" id="tab-feats" style="display:none">
            <div class="card">
              <h3>-- Feats --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_feat_name" placeholder="Feat name"/>
                <button id="addFeat">Add</button>
              </div>
              <div class="list-wrap" id="feats_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>-- Cyberware --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_cyber_name" placeholder="Cyberware name"/>
                <button id="addCyber">Add</button>
              </div>
              <div class="list-wrap" id="cyber_list"></div>
            </div>
          </div>

          <!-- ABILITIES & SPELLS TAB -->
          <div class="tab-panel" id="tab-abilities" style="display:none">
            <div class="card">
              <h3>Abilities</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_ability_name" placeholder="Ability name"/>
                <button id="addAbility">Add</button>
              </div>
              <div class="list-wrap" id="abilities_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Spells</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_spell_name" placeholder="Spell name"/>
                <input id="new_spell_level" style="width:70px" placeholder="Lvl"/>
                <button id="addSpell">Add</button>
              </div>
              <div class="list-wrap" id="spells_list"></div>
            </div>
          </div>

          <!-- EQ & NOTES TAB -->
          <div class="tab-panel" id="tab-eq" style="display:none">
            <div class="card">
              <h3>Equipment</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_equip" placeholder="Item name (single-line)"/>
                <button id="addEquip">Add</button>
              </div>
              <div class="list-wrap" id="equip_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Vehicles</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_vehicle_name" placeholder="Vehicle name"/>
                <button id="addVehicle">Add</button>
              </div>
              <div class="list-wrap" id="vehicles_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Notes</h3>
              <textarea id="notes" placeholder="General notes, campaign hooks, NPCs..."></textarea>
            </div>
          </div>

          <!-- COMBAT INTERFACE TAB -->
          <div class="tab-panel" id="tab-combat" style="display:none">
            <div class="card">
              <h3>Combat Basics</h3>
              <div class="row">
                <div style="flex:1;display:flex;gap:8px">
                  <div style="flex:1"><label>Armor Class</label><input id="ac" type="text"></div>
                  <div style="flex:1"><label>Speed</label><input id="speed" type="text"></div>
                </div>
              </div>

              <div class="row" style="align-items:center">
                <div style="flex:1;display:flex;gap:8px;align-items:center">
                  <div style="flex:1"><label>HP (Max / Temp / Current)</label>
                    <div style="display:flex;gap:8px">
                      <input id="hp_max" type="number" placeholder="Max">
                      <input id="hp_temp" type="number" placeholder="Temp">
                      <input id="hp_cur" type="number" placeholder="Current">
                    </div>
                  </div>
                </div>

                <div style="width:120px;text-align:center">
                  <label>Initiative</label>
                  <div style="display:flex;gap:8px;align-items:center;justify-content:center">
                    <input id="initiative_val" type="text" readonly style="width:72px;text-align:center;background:#111"/>
                    <button id="roll_init" class="roll-btn" title="Roll Initiative"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Saves</h3>
              <div class="saves-grid">
                <div class="save-box"><div>STR Save <small id="save_box_STR" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:STR" title="Roll STR Save"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
                <div class="save-box"><div>DEX Save <small id="save_box_DEX" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:DEX"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
                <div class="save-box"><div>CON Save <small id="save_box_CON" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:CON"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
                <div class="save-box"><div>INT Save <small id="save_box_INT" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:INT"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
                <div class="save-box"><div>WIS Save <small id="save_box_WIS" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:WIS"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
                <div class="save-box"><div>CHA Save <small id="save_box_CHA" class="muted-sm">+0</small></div><button class="roll-btn" data-roll="save:CHA"><svg class="roll-icon" viewBox="0 0 24 24"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z"/></svg></button></div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attacks</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="attack_name_input" placeholder="Name (e.g. Street Pistol)"/>
                <input id="attack_bonus_input" placeholder="+atk" style="width:72px"/>
                <input id="attack_damage_input" placeholder="1d8+2" style="width:120px"/>
                <input id="attack_dtype_input" placeholder="type" style="width:80px"/>
                <button id="addAttack">Add</button>
              </div>
              <div class="list-wrap" id="attacks_list"></div>
              <div class="muted-sm" style="margin-top:8px">Click the attack button to roll attack (d20 + bonus). Click damage to roll damage expression.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Resistances</h3>
              <textarea id="resistances" placeholder="List resistances, immunities, vulnerabilities..."></textarea>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Discord Webhook (optional)</h3>
              <div class="row"><label>Webhook URL</label><input id="webhook_url" placeholder="https://discord.com/api/webhooks/..." /></div>
              <div class="muted-sm">When set, rolls will send a styled embed to the webhook. Keep empty to disable.</div>
            </div>
          </div>

        </div>

        <!-- RIGHT: snapshot & lists -->
        <div>
          <div class="card snapshot">
            <h3>Snapshot</h3>
            <div class="row"><strong>Name</strong><div id="snap_name" class="muted">—</div></div>
            <div class="row"><strong>Class / Level</strong><div id="snap_class" class="muted">—</div></div>
            <div class="row"><strong>HP</strong><div id="snap_hp" class="muted">0 / 0</div></div>
            <div class="row"><strong>AC</strong><div id="snap_ac" class="muted">—</div></div>
            <div class="row"><strong>Sanity / Corr.</strong><div id="snap_sanity" class="muted">—</div></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Quick Lists</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <h4 style="margin:6px 0 6px 0;color:var(--neon);font-size:12px">Feats</h4>
                <div id="quick_feats" class="muted-sm">Use Feats tab to edit.</div>
              </div>
              <div>
                <h4 style="margin:6px 0 6px 0;color:var(--neon);font-size:12px">Cyberware</h4>
                <div id="quick_cyber" class="muted-sm">Use Cyberware tab to edit.</div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Help</h3>
            <p class="muted" style="font-size:13px;margin:0">This sheet stores data locally. Export to transfer characters. Rolls visible locally and optionally posted to Discord via webhook.</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Roll log overlay (collapsed by default) -->
  <div class="roll-log" id="roll_log_root">
    <div id="log_panel" class="log-panel" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="font-weight:700;color:var(--neon)">Roll Log</div>
        <div class="muted-sm" style="margin-left:auto"><button id="clear_log">Clear</button></div>
      </div>
      <div id="log_items" style="max-height:340px;overflow:auto"></div>
    </div>
    <div id="log_tab" class="roll-tab" title="Open roll log">
      <!-- small neon hex -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2 L19 6.5 L19 17.5 L12 22 L5 17.5 L5 6.5 Z" fill="#fff" opacity="0.98"/></svg>
    </div>
  </div>

<script>
/* -------------------------
   Constants & helpers
   ------------------------- */
const STORAGE_KEY = 'cybercraft_sheet_v2';
const SKILLS = {
  athletics:'STR', acrobatics:'DEX', sleight:'DEX', stealth:'DEX', driving:'DEX',
  arcana:'INT', history:'INT', investigation:'INT', nature:'INT', religion:'INT', technology:'INT',
  animal:'WIS', insight:'WIS', medicine:'WIS', perception:'WIS', survival:'WIS',
  deception:'CHA', intimidation:'CHA', performance:'CHA', persuasion:'CHA'
};
function abilityMod(score){ const s=parseInt(score)||0; return Math.floor((s-10)/2); }
function proficiencyByLevel(lvl){ lvl = parseInt(lvl)||1; return Math.ceil(lvl/4)+1; }
function fmtSign(n){ return (n>=0?'+':'') + n; }
function nowTime(){ const d=new Date(); return d.toLocaleTimeString(); }

/* -------------------------
   DOM helpers
   ------------------------- */
function qsel(s){ return document.querySelector(s); }
function qselAll(s){ return Array.from(document.querySelectorAll(s)); }

/* -------------------------
   Tab handling
   ------------------------- */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
    document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
  });
});

/* -------------------------
   Portrait upload
   ------------------------- */
const portraitWrap = qsel('#portrait_wrap');
qsel('#portrait_file').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{ portraitWrap.innerHTML = '<img src="'+r.result+'"/>'; saveToStorage(); window._portraitData = r.result; };
  r.readAsDataURL(f);
});

/* -------------------------
   Dynamic lists: Feats, Cyber, Abilities, Spells, Equip, Vehicles, Attacks
   ------------------------- */
function renderList(containerId, items, templateFn){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  items.forEach((it,i)=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = templateFn(it,i);
    wrap.appendChild(el);
  });
}

/* Feats */
window._feats = window._feats || [];
function renderFeats(){ renderList('feats_list', window._feats, (f,i)=>`
  <div style="flex:1">
    <input class="feat_name" data-i="${i}" value="${escapeHtml(f.name||'')}" placeholder="Feat name"/>
    <textarea class="feat_desc" data-i="${i}" placeholder="Description">${escapeHtml(f.desc||'')}</textarea>
  </div>
  <div><button class="remove_feat" data-i="${i}">Remove</button></div>
`); updateQuickLists(); }
qsel('#addFeat').addEventListener('click', ()=>{
  const name = qsel('#new_feat_name').value.trim(); if(!name) return alert('Enter feat name');
  window._feats.push({name:name,desc:''}); qsel('#new_feat_name').value=''; renderFeats(); saveToStorage();
});
qsel('#feats_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_feat')){ const i=parseInt(e.target.dataset.i); window._feats.splice(i,1); renderFeats(); saveToStorage(); }
});
qsel('#feats_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('feat_name')) window._feats[i].name = e.target.value;
  if(cls.includes('feat_desc')) window._feats[i].desc = e.target.value;
  saveToStorage();
});

/* Cyberware */
window._cyber = window._cyber || [];
function renderCyber(){ renderList('cyber_list', window._cyber, (c,i)=>`
  <div style="flex:1">
    <input class="cyber_name" data-i="${i}" value="${escapeHtml(c.name||'')}" placeholder="Cyberware name"/>
    <textarea class="cyber_desc" data-i="${i}" placeholder="Description (optional)">${escapeHtml(c.desc||'')}</textarea>
  </div>
  <div><button class="remove_cyber" data-i="${i}">Remove</button></div>
`); updateQuickLists(); }
qsel('#addCyber').addEventListener('click', ()=>{
  const name=qsel('#new_cyber_name').value.trim(); if(!name) return alert('Enter cyberware name');
  window._cyber.push({name:name,desc:''}); qsel('#new_cyber_name').value=''; renderCyber(); saveToStorage();
});
qsel('#cyber_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_cyber')){ const i=parseInt(e.target.dataset.i); window._cyber.splice(i,1); renderCyber(); saveToStorage(); }
});
qsel('#cyber_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('cyber_name')) window._cyber[i].name = e.target.value;
  if(cls.includes('cyber_desc')) window._cyber[i].desc = e.target.value;
  saveToStorage();
});

/* Abilities */
window._abilities = window._abilities || [];
function renderAbilities(){ renderList('abilities_list', window._abilities, (a,i)=>`
  <div style="flex:1">
    <input class="ability_name" data-i="${i}" value="${escapeHtml(a.name||'')}" placeholder="Ability name"/>
    <textarea class="ability_desc" data-i="${i}" placeholder="Description">${escapeHtml(a.desc||'')}</textarea>
  </div>
  <div><button class="remove_ability" data-i="${i}">Remove</button></div>
`); }
qsel('#addAbility').addEventListener('click', ()=>{
  const name=qsel('#new_ability_name').value.trim(); if(!name) return alert('Enter ability name');
  window._abilities.push({name:name,desc:''}); qsel('#new_ability_name').value=''; renderAbilities(); saveToStorage();
});
qsel('#abilities_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_ability')){ const i=parseInt(e.target.dataset.i); window._abilities.splice(i,1); renderAbilities(); saveToStorage(); }
});
qsel('#abilities_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('ability_name')) window._abilities[i].name = e.target.value;
  if(cls.includes('ability_desc')) window._abilities[i].desc = e.target.value;
  saveToStorage();
});

/* Spells */
window._spells = window._spells || [];
function renderSpells(){ renderList('spells_list', window._spells, (s,i)=>`
  <div style="flex:1">
    <input class="spell_name" data-i="${i}" value="${escapeHtml(s.name||'')}" placeholder="Spell name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="spell_level" data-i="${i}" style="width:70px" value="${escapeHtml(s.level||'')}" placeholder="Level"/>
      <input class="spell_time" data-i="${i}" style="flex:1" value="${escapeHtml(s.time||'')}" placeholder="Casting time / Range / Duration"/>
    </div>
    <textarea class="spell_desc" data-i="${i}" placeholder="Details">${escapeHtml(s.desc||'')}</textarea>
  </div>
  <div><button class="remove_spell" data-i="${i}">Remove</button></div>
`); }
qsel('#addSpell').addEventListener('click', ()=>{
  const name=qsel('#new_spell_name').value.trim(); const lvl=qsel('#new_spell_level').value.trim();
  if(!name) return alert('Enter spell name');
  window._spells.push({name:name,level:lvl,time:'',desc:''}); qsel('#new_spell_name').value=''; qsel('#new_spell_level').value=''; renderSpells(); saveToStorage();
});
qsel('#spells_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_spell')){ const i=parseInt(e.target.dataset.i); window._spells.splice(i,1); renderSpells(); saveToStorage(); }
});
qsel('#spells_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('spell_name')) window._spells[i].name = e.target.value;
  if(cls.includes('spell_level')) window._spells[i].level = e.target.value;
  if(cls.includes('spell_time')) window._spells[i].time = e.target.value;
  if(cls.includes('spell_desc')) window._spells[i].desc = e.target.value;
  saveToStorage();
});

/* Equipment (single-line) */
window._equip = window._equip || [];
function renderEquip(){ renderList('equip_list', window._equip, (it,i)=>`
  <div style="flex:1">
    <input class="equip_item" data-i="${i}" value="${escapeHtml(it||'')}" placeholder="Item name"/>
  </div>
  <div><button class="remove_equip" data-i="${i}">Remove</button></div>
`); }
qsel('#addEquip').addEventListener('click', ()=>{
  const name=qsel('#new_equip').value.trim(); if(!name) return alert('Enter item'); window._equip.push(name); qsel('#new_equip').value=''; renderEquip(); saveToStorage();
});
qsel('#equip_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_equip')){ const i=parseInt(e.target.dataset.i); window._equip.splice(i,1); renderEquip(); saveToStorage(); }
});
qsel('#equip_list').addEventListener('input',(e)=>{
  if(e.target.classList.contains('equip_item')){ const i=parseInt(e.target.dataset.i); window._equip[i] = e.target.value; saveToStorage(); }
});

/* Vehicles */
window._vehicles = window._vehicles || [];
function renderVehicles(){ renderList('vehicles_list', window._vehicles, (v,i)=>`
  <div style="flex:1">
    <input class="veh_name" data-i="${i}" value="${escapeHtml(v.name||'')}" placeholder="Vehicle name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="veh_type" data-i="${i}" style="width:120px" value="${escapeHtml(v.type||'')}" placeholder="Type"/>
      <input class="veh_speed" data-i="${i}" style="width:100px" value="${escapeHtml(v.speed||'')}" placeholder="Speed"/>
      <input class="veh_ac" data-i="${i}" style="width:80px" value="${escapeHtml(v.ac||'')}" placeholder="AC"/>
    </div>
    <textarea class="veh_desc" data-i="${i}" placeholder="Upgrades / Notes">${escapeHtml(v.desc||'')}</textarea>
  </div>
  <div><button class="remove_vehicle" data-i="${i}">Remove</button></div>
`); }
qsel('#addVehicle').addEventListener('click', ()=>{
  const name=qsel('#new_vehicle_name').value.trim(); if(!name) return alert('Enter vehicle name');
  window._vehicles.push({name:name,type:'',speed:'',ac:'',desc:''}); qsel('#new_vehicle_name').value=''; renderVehicles(); saveToStorage();
});
qsel('#vehicles_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_vehicle')){ const i=parseInt(e.target.dataset.i); window._vehicles.splice(i,1); renderVehicles(); saveToStorage(); }
});
qsel('#vehicles_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('veh_name')) window._vehicles[i].name = e.target.value;
  if(cls.includes('veh_type')) window._vehicles[i].type = e.target.value;
  if(cls.includes('veh_speed')) window._vehicles[i].speed = e.target.value;
  if(cls.includes('veh_ac')) window._vehicles[i].ac = e.target.value;
  if(cls.includes('veh_desc')) window._vehicles[i].desc = e.target.value;
  saveToStorage();
});

/* Attacks */
window._attacks = window._attacks || [];
function renderAttacks(){
  const wrap = qsel('#attacks_list'); wrap.innerHTML='';
  window._attacks.forEach((a,i)=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `
      <div style="flex:1;display:grid;grid-template-columns:1fr 80px 1fr 90px 44px;gap:8px;align-items:center">
        <input class="atk_name" data-i="${i}" value="${escapeHtml(a.name||'')}" placeholder="Name"/>
        <input class="atk_bonus" data-i="${i}" value="${escapeHtml(a.bonus||'')}" placeholder="+atk"/>
        <div style="display:flex;gap:6px;">
          <input class="atk_dmg" data-i="${i}" value="${escapeHtml(a.damage||'')}" placeholder="1d8+2" style="width:62%"/>
          <input class="atk_type" data-i="${i}" value="${escapeHtml(a.dtype||'')}" placeholder="type" style="width:38%"/>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="roll_atk" data-i="${i}" title="Roll Attack" style="width:72px">Atk</button>
          <button class="roll_dmg" data-i="${i}" title="Roll Damage">Dmg</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="remove_atk" data-i="${i}">Remove</button>
        </div>
      </div>
    `;
    wrap.appendChild(el);
  });
}
qsel('#addAttack').addEventListener('click', ()=>{
  const n=qsel('#attack_name_input').value.trim(), b=qsel('#attack_bonus_input').value.trim(), d=qsel('#attack_damage_input').value.trim(), t=qsel('#attack_dtype_input').value.trim();
  if(!n) return alert('Enter attack name');
  window._attacks.push({name:n,bonus:b,damage:d,dtype:t}); qsel('#attack_name_input').value=''; qsel('#attack_bonus_input').value=''; qsel('#attack_damage_input').value=''; qsel('#attack_dtype_input').value=''; renderAttacks(); saveToStorage();
});
qsel('#attacks_list').addEventListener('click',(e)=>{
  const i=parseInt(e.target.dataset.i);
  if(e.target.classList.contains('remove_atk')){ window._attacks.splice(i,1); renderAttacks(); saveToStorage(); }
  if(e.target.classList.contains('roll_atk')){ rollAttack(i); }
  if(e.target.classList.contains('roll_dmg')){ rollDamageExpr(window._attacks[i].damage, 'Damage ('+ (window._attacks[i].dtype||'') +')'); }
});
qsel('#attacks_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('atk_name')) window._attacks[i].name = e.target.value;
  if(cls.includes('atk_bonus')) window._attacks[i].bonus = e.target.value;
  if(cls.includes('atk_dmg')) window._attacks[i].damage = e.target.value;
  if(cls.includes('atk_type')) window._attacks[i].dtype = e.target.value;
  saveToStorage();
});

/* -------------------------
   Save / Load
   ------------------------- */
function gatherState(){
  const state = {};
  const ids = [
    'name','player','race','class_text','level','background','faction','alignment',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','initiative_val','speed','hp_max','hp_temp','hp_cur',
    'sanity','corruption','sanity_notes','notes','resistances','webhook_url'
  ];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    state[id] = (el.type==='checkbox') ? el.checked : el.value;
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=document.getElementById('prof_'+s), e=document.getElementById('exp_'+s);
    state['prof_'+s] = p ? p.checked : false;
    state['exp_'+s] = e ? e.checked : false;
  });
  state.feats = window._feats||[]; state.cyber = window._cyber||[]; state.abilities = window._abilities||[]; state.spells = window._spells||[];
  state.equip = window._equip||[]; state.vehicles = window._vehicles||[]; state.attacks = window._attacks||[];
  state.attacks = window._attacks || [];
  state.portrait = window._portraitData || '';
  return state;
}
function applyState(state){
  if(!state) return;
  const ids = [
    'name','player','race','class_text','level','background','faction','alignment',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','initiative_val','speed','hp_max','hp_temp','hp_cur',
    'sanity','corruption','sanity_notes','notes','resistances','webhook_url'
  ];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el || state[id]===undefined) return;
    if(el.type==='checkbox') el.checked = !!state[id]; else el.value = state[id];
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=document.getElementById('prof_'+s); if(p) p.checked = !!state['prof_'+s];
    const e=document.getElementById('exp_'+s); if(e) e.checked = !!state['exp_'+s];
  });
  window._feats = state.feats||[]; window._cyber = state.cyber||[]; window._abilities = state.abilities||[]; window._spells = state.spells||[]; window._equip = state.equip||[]; window._vehicles = state.vehicles||[]; window._attacks = state.attacks||[];
  renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
  window._portraitData = state.portrait || '';
  if(window._portraitData){ portraitWrap.innerHTML = '<img src="'+window._portraitData+'"/>'; }
  updateAllCalculations(); updateSnapshot();
}
function saveToStorage(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(gatherState())); }catch(e){console.error(e);} }
function loadFromStorage(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; applyState(JSON.parse(raw)); }catch(e){console.error(e);} }

/* -------------------------
   Dice helpers
   ------------------------- */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function rollD20(){ return randInt(1,20); }
function parseDiceExpr(expr){
  // supports NdM+K or NdM-K or K
  expr = (expr||'').replace(/\s+/g,'');
  if(!expr) return {total:0,text:'0'};
  let total=0, parts=[], match;
  const diceRe = /([+-]?)(\d*)d(\d+)/g;
  let rest=expr;
  while((match = diceRe.exec(expr))!==null){
    const sign = match[1]==='-'?-1:1;
    const count = parseInt(match[2])||1;
    const sides = parseInt(match[3]);
    const rolls=[];
    for(let i=0;i<count;i++){ const r=randInt(1,sides); rolls.push(r); total += sign*r; parts.push((sign===-1?'-':'')+count+'d'+sides+'('+rolls.join(',')+')'); }
    rest = rest.replace(match[0],'');
  }
  // final flat modifier
  const flatRe = /([+-]\d+)/g;
  let fm; while((fm = flatRe.exec(rest))!==null){ total += parseInt(fm[0]); parts.push(fm[0]); }
  if(parts.length===0){
    // maybe a single number
    const v = parseInt(expr);
    if(!isNaN(v)){ total = v; parts.push(''+v); }
  }
  return { total: total, text: parts.join(' + ') || expr };
}

/* -------------------------
   Roll & webhook functions
   ------------------------- */
window._rollHistory = window._rollHistory || [];
function addLog(entry){
  window._rollHistory.unshift(entry);
  // keep 200 max
  if(window._rollHistory.length>200) window._rollHistory.length=200;
  renderLog();
  saveToStorage();
  // expand and pulse briefly
  openLogPanel(true);
}
function renderLog(){
  const wrap = qsel('#log_items'); wrap.innerHTML='';
  window._rollHistory.slice(0,120).forEach(it=>{
    const d = document.createElement('div'); d.className='log-item';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><div><strong style="color:var(--neon)">${escapeHtml(it.title||'Roll')}</strong><div style="font-size:13px;margin-top:4px">${escapeHtml(it.resultText)}</div></div><div style="text-align:right">${escapeHtml(it.total)}</div></div><small>${escapeHtml(it.subtitle||'')} • ${escapeHtml(it.time||'')}</small>`;
    wrap.appendChild(d);
  });
}
function formatRollForDiscord(charName, title, resultText, total){
  return {
    username: charName || 'Cybercraft',
    embeds: [{
      title: title,
      description: resultText + "\n\n**Result:** " + total,
      color: parseInt('0x' + ( (function(){ const c = '9B30FF'.replace('#',''); return c; })() )),
      footer: { text: 'Cybercraft 5e — Roll' }
    }]
  };
}
async function maybeSendWebhook(entry){
  const url = (qsel('#webhook_url') || {}).value || '';
  if(!url) return;
  try{
    const payload = formatRollForDiscord(qsel('#name').value, entry.title, entry.resultText, entry.total);
    await fetch(url, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  }catch(e){ console.warn('Webhook failed', e); }
}

/* -------------------------
   Rolling actions
   ------------------------- */
function doRoll(what, bonus, subtitle){
  const d = rollD20(); const total = d + (parseInt(bonus)||0);
  const entry = { title:what, resultText: d + ' + ' + (bonus||0) + ' = ' + total, total: total, time: nowTime(), subtitle: subtitle||'' };
  addLog(entry);
  maybeSendWebhook(entry);
  return entry;
}
function rollSkill(skillKey){
  const ab = SKILLS[skillKey]; const score = parseInt(qsel('#attr_'+ab).value)||0;
  const abmod = abilityMod(score);
  const prof = proficiencyByLevel(parseInt(qsel('#level').value)||1);
  const profCheck = qsel('#prof_'+skillKey) ? qsel('#prof_'+skillKey).checked : false;
  const expCheck = qsel('#exp_'+skillKey) ? qsel('#exp_'+skillKey).checked : false;
  let bonus = abmod;
  if(profCheck) bonus += prof * (expCheck ? 2 : 1);
  const entry = doRoll('Skill: '+capitalize(skillKey), bonus, skillKey + ' check');
  return entry;
}
function rollSave(ab){
  const score = parseInt(qsel('#attr_'+ab).value)||0;
  const abmod = abilityMod(score);
  const prof = proficiencyByLevel(parseInt(qsel('#level').value)||1);
  const profCheck = qsel('#save_prof_'+ab) ? qsel('#save_prof_'+ab).checked : false;
  let bonus = abmod + (profCheck ? prof : 0);
  const entry = doRoll(ab + ' Save', bonus, ab + ' saving throw');
  return entry;
}
function rollAttack(i){
  const atk = window._attacks[i];
  const bonus = parseInt(atk.bonus)||0;
  const entry = doRoll(atk.name + ' attack', bonus, 'Attack roll');
  return entry;
}
function rollDamageExpr(expr, label){
  const parsed = parseDiceExpr(expr);
  const entry = { title:label || 'Damage', resultText: parsed.text + ' = ' + parsed.total, total: parsed.total, time: nowTime(), subtitle: expr };
  addLog(entry);
  maybeSendWebhook(entry);
  return entry;
}

/* -------------------------
   Misc: helpers & UI glue
   ------------------------- */
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------------
   UI wiring for roll buttons
   ------------------------- */
document.addEventListener('click', (e)=>{
  // skill roll buttons (data-roll="skill:xxx")
  const rb = e.target.closest('.roll-btn');
  if(rb && rb.dataset && rb.dataset.roll){
    // visual ripple
    rb.classList.remove('ripple'); void rb.offsetWidth; rb.classList.add('ripple');
    const parts = rb.dataset.roll.split(':');
    if(parts[0]==='skill'){ rollSkill(parts[1]); }
    if(parts[0]==='save'){ rollSave(parts[1]); }
    return;
  }
});

/* specific roll buttons */
qsel('#roll_init').addEventListener('click', ()=>{
  const dex = parseInt(qsel('#attr_DEX').value)||0; const dmod = abilityMod(dex);
  const e = doRoll('Initiative', dmod, 'Initiative roll');
  qsel('#initiative_val').value = fmtSign(dmod) + ' (' + e.total + ')';
});

/* saves panel buttons (they have data-roll attr as well) */
qselAll('[data-roll^="save:"]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const ab = btn.dataset.roll.split(':')[1]; rollSave(ab); });
});

/* skill button wiring (buttons also have data-roll) */
qselAll('[data-roll^="skill:"]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const sk = btn.dataset.roll.split(':')[1]; rollSkill(sk); });
});

/* roll attack/damage buttons created dynamically in attacks list */
function rollAttack(i){ // uses attack list directly
  const atk = window._attacks[i];
  const bonus = parseInt((atk.bonus||'0').replace('+',''))||0;
  const d = rollD20(); const total = d + bonus;
  const entry = { title: atk.name + ' Attack', resultText: d + ' + ' + (bonus>=0?'+':'') + bonus + ' = ' + total, total: total, time: nowTime(), subtitle: 'Attack Roll' };
  addLog(entry); maybeSendWebhook(entry);
}
function rollDamageExpr(expr, label){
  const parsed = parseDiceExpr(expr);
  const entry = { title: label || 'Damage', resultText: parsed.text + ' = ' + parsed.total, total: parsed.total, time: nowTime(), subtitle: expr };
  addLog(entry); maybeSendWebhook(entry);
}

/* roll dmg buttons in attacks handled above by click handler on attacks_list */

/* -------------------------
   Update calculations: skills, saves, init, snapshot
   ------------------------- */
function updateAllCalculations(){
  const level = parseInt(qsel('#level').value) || 1;
  const prof = proficiencyByLevel(level);
  qsel('#prof_display')?.value = (prof>=0?'+':'') + prof;

  ['STR','DEX','CON','INT','WIS','CHA'].forEach(ab=>{
    const score = parseInt(qsel('#attr_'+ab).value)||0;
    const mod = abilityMod(score);
    const profCheck = qsel('#save_prof_'+ab).checked;
    const total = mod + (profCheck ? prof : 0);
    qsel('#save_bonus_'+ab).textContent = fmtSign(total);
    qsel('#save_box_'+ab).textContent = fmtSign(total);
  });

  Object.keys(SKILLS).forEach(s=>{
    const ab = SKILLS[s];
    const score = parseInt(qsel('#attr_'+ab).value)||0;
    const abmod = abilityMod(score);
    const profCheck = qsel('#prof_'+s) ? qsel('#prof_'+s).checked : false;
    const expCheck = qsel('#exp_'+s) ? qsel('#exp_'+s).checked : false;
    let bonus = abmod;
    if(profCheck) bonus += prof * (expCheck ? 2 : 1);
    const el = qsel('#bonus_'+s);
    if(el) el.textContent = fmtSign(bonus);
  });

  // initiative value display (calc only, actual roll is via button)
  const dex = parseInt(qsel('#attr_DEX').value)||0; const imod = abilityMod(dex);
  // show modifier in placeholder if initiative not rolled
  if(qsel('#initiative_val').value==='') qsel('#initiative_val').placeholder = fmtSign(imod);

  // update snapshot
  updateSnapshot();

  saveToStorage();
}

/* -------------------------
   Snapshot UI
   ------------------------- */
function updateSnapshot(){
  qsel('#snap_name').textContent = qsel('#name').value || '—';
  qsel('#snap_class').textContent = (qsel('#class_text').value||'—') + ' / ' + (qsel('#level').value||'—');
  qsel('#snap_hp').textContent = (qsel('#hp_cur').value||'—') + ' / ' + (qsel('#hp_max').value||'—');
  qsel('#snap_ac').textContent = qsel('#ac').value || '—';
  qsel('#snap_sanity').textContent = (qsel('#sanity').value||'—') + ' / ' + (qsel('#corruption').value||'—');
}

/* -------------------------
   Roll log panel controls
   ------------------------- */
const logPanel = qsel('#log_panel'), logTab = qsel('#log_tab');
let logOpen = false;
function openLogPanel(forceOpen){
  if(forceOpen) { logPanel.style.display='block'; logOpen=true; return; }
  if(!logOpen){ logPanel.style.display='block'; logOpen=true; } else { logPanel.style.display='none'; logOpen=false; }
}
logTab.addEventListener('click', ()=> openLogPanel());
qsel('#clear_log').addEventListener('click', ()=>{ window._rollHistory = []; renderLog(); saveToStorage(); });

/* -------------------------
   Export / Import / Print / Clear
   ------------------------- */
qsel('#export').addEventListener('click', ()=>{
  const raw = JSON.stringify(gatherState());
  const blob = new Blob([raw],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (qsel('#name').value||'character') + '.cyber.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
qsel('#importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = (e)=>{ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const parsed = JSON.parse(r.result); applyState(parsed); alert('Import OK'); }catch(err){ alert('Import failed: invalid file'); } }; r.readAsText(f); }; input.click();
});
qsel('#print').addEventListener('click', ()=>window.print());
qsel('#clear').addEventListener('click', ()=>{ if(confirm('Clear local sheet data? This cannot be undone.')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

/* -------------------------
   Misc listeners & boot
   ------------------------- */
function attachListeners(){
  const watch = [
    'level','attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'sanity','corruption','hp_cur','hp_max','ac','initiative_val','speed','notes','resistances','webhook_url'
  ];
  watch.forEach(id=>{
    const el=qsel('#'+id); if(!el) return;
    if(el.type==='checkbox') el.addEventListener('change', updateAllCalculations);
    else el.addEventListener('input', ()=>{ if(window._calcTimer) clearTimeout(window._calcTimer); window._calcTimer=setTimeout(()=>updateAllCalculations(),180);});
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=qsel('#prof_'+s); const e=qsel('#exp_'+s);
    if(p) p.addEventListener('change', updateAllCalculations);
    if(e) e.addEventListener('change', updateAllCalculations);
  });

  // ensure attacks list click wiring
  qsel('#attacks_list').addEventListener('click',(e)=>{
    if(e.target.classList.contains('roll_atk')){ const i=parseInt(e.target.dataset.i); rollAttack(i); }
    if(e.target.classList.contains('roll_dmg')){ const i=parseInt(e.target.dataset.i); rollDamageExpr(window._attacks[i].damage, window._attacks[i].name+' Damage'); }
  });

  // save on any input
  document.querySelectorAll('input,textarea,select').forEach(el=>{
    el.addEventListener('input', ()=>{ if(window._saveTimer) clearTimeout(window._saveTimer); window._saveTimer = setTimeout(()=>saveToStorage(),420); });
  });
}
attachListeners();

function updateQuickLists(){
  qsel('#quick_feats').textContent = window._feats.map(f=>f.name).slice(0,6).join(', ') || '—';
  qsel('#quick_cyber').textContent = window._cyber.map(c=>c.name).slice(0,6).join(', ') || '—';
}

/* -------------------------
   Boot
   ------------------------- */
renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
loadFromStorage();
setTimeout(()=>{ updateAllCalculations(); updateSnapshot(); renderLog(); },200);

</script>
</body>
</html>
