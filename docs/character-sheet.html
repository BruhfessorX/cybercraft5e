<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cybercraft 5e — Character Sheet (v3)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0e10;
    --panel:#1a1a1c;
    --input:#262628;
    --neon:#9B30FF;         /* original accent */
    --muted:#c6cad2;
    --glass: rgba(255,255,255,0.02);
    --accent-glow: 0 0 20px rgba(155,48,255,0.22), inset 0 0 8px rgba(0,0,0,0.35);
    --field-border: rgba(155,48,255,0.06);
    --dice-color: #00D1FF;  /* Cyan-blue dice color */
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(900px 400px at 10% 8%, rgba(155,48,255,0.02), transparent),
    linear-gradient(180deg,#080809 0%,var(--bg) 50%);
    color:var(--muted); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .container{max-width:1120px;margin:28px auto;padding:22px;}

  .titlebar{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--neon), #5b0fbf);border-radius:10px;box-shadow:var(--accent-glow);display:flex;align-items:center;justify-content:center;font-family:Orbitron;color:#050005;font-weight:700}
  .title-text h1{margin:0;font-family:Orbitron;color:var(--neon);font-size:20px;text-shadow:0 0 10px rgba(155,48,255,0.16)}
  .title-text p{margin:0;font-size:12px;color:#aeb5c3}

  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}

  .tabs{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:linear-gradient(180deg, rgba(155,48,255,0.06), rgba(155,48,255,0.02));box-shadow:var(--accent-glow);color:white;border:1px solid rgba(155,48,255,0.25);transform:translateY(-2px)}

  .panel{background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.03);padding:16px;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  .panel-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:980px){.panel-grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border-radius:10px;padding:12px;border:1px solid var(--field-border)}
  .card h3{margin:0 0 8px 0;color:var(--neon);font-family:Orbitron;font-size:13px}
  label{font-size:13px;color:#bfc5cf;min-width:120px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:8px 10px;background:var(--input);border-radius:7px;border:1px solid rgba(0,0,0,0.3);color:var(--muted);outline:none;font-size:13px;
  }
  input:focus, textarea:focus, select:focus{box-shadow:var(--accent-glow);border-color:var(--neon);color:#fff;background:#1f1f20}
  textarea{min-height:80px;resize:vertical}

  .attributes{display:flex;gap:10px;flex-wrap:wrap}
  .attr-box{width:82px;background:linear-gradient(180deg,rgba(0,0,0,0.12),transparent);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--field-border)}
  .attr-box .score{font-size:18px;color:#fff;font-weight:700}
  .attr-box .label{font-size:12px;color:#c6cad2;margin-top:6px}
  .save-row{font-size:12px;color:#c6cad2;margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px}

  .skill-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .skill-row label{min-width:160px;color:#c6cad2}
  .checkbox-inline{display:flex;align-items:center;gap:6px;color:#bfc4cf;font-size:13px}
  .skill-bonus{min-width:48px;text-align:right;font-weight:700;color:#fff}

  .list-wrap{max-height:260px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(155,48,255,0.04);background:rgba(255,255,255,0.005)}
  .list-item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
  .list-item input, .list-item textarea{background:#1a1b1d}
  .list-item .remove{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:4px 8px;border-radius:6px;cursor:pointer}

  .btnbar{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--neon),#5b0fbf);color:white;box-shadow:var(--accent-glow);border:none}
  .muted{color:#9aa0b5;font-size:12px}

  .snapshot .row{justify-content:space-between}
  .snapshot strong{color:#fff}

  /* Hex dice icon */
  .dice-hex{
    width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:4px;
    background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.07));
    border:1px solid rgba(255,255,255,0.03);
    cursor:pointer;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
    transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
  }
  .dice-hex svg { display:block; width:14px; height:14px; }
  .dice-hex:hover{ transform:scale(1.06); box-shadow:0 0 14px rgba(0,209,255,0.18)}
  .dice-hex.pulse{ animation: dicePulse .42s ease-out; }
  @keyframes dicePulse { 0%{ transform: scale(1) } 40%{ transform: scale(1.18) } 100%{ transform: scale(1)} }

  /* Roll log overlay */
  .roll-log{
    position:fixed; right:18px; top:18px; width:300px; max-height:60vh; overflow:auto; border-radius:10px;
    background: linear-gradient(180deg, rgba(2,10,12,0.9), rgba(0,0,0,0.75)); color:#cfeff6; padding:10px; z-index:2000;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 18px rgba(0,209,255,0.06);
    border:1px solid rgba(0,209,255,0.06);
    transition:opacity .28s ease, transform .28s ease;
  }
  .roll-log.collapsed{ opacity:0; transform: translateY(-6px) scale(.98); pointer-events:none; height:0; padding:4px; overflow:hidden;}
  .roll-log .head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .roll-log .entries{max-height:46vh; overflow:auto}
  .roll-item{padding:6px;border-radius:6px;margin-bottom:6px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.02)}
  .roll-item .title{font-weight:700;color:#eafcff;font-size:13px}
  .roll-actions{display:flex;gap:8px;justify-content:space-between;margin-top:8px}
  .roll-log .clear{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:6px;cursor:pointer;color:#c6cad2}

  /* small inline roll button */
  .inline-roll{
    display:inline-flex;align-items:center;gap:6px;margin-left:8px;
  }
  .inline-roll .dice-hex{ width:20px;height:20px; }

  /* small attack layout */
  .attack-row{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .attack-row input[type="text"], .attack-row input[type="number"]{padding:6px 8px;font-size:13px}
  .attack-row .attack-actions{display:flex;gap:6px;align-items:center;margin-left:auto}

  @media print{
    body{background:white;color:black}
    .titlebar, .tabs, .btnbar{display:none}
    input,textarea{border:1px solid #aaa;color:black;background:white}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <div class="logo">CV</div>
      <div class="title-text">
        <h1>Cybercraft 5e</h1>
        <p>Interactive Character Sheet — Echo City</p>
      </div>

      <div class="controls">
        <button id="export">Export</button>
        <button id="importBtn">Import</button>
        <button id="clear">Clear</button>
        <button id="print" class="primary">Print</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="core">Core</div>
      <div class="tab" data-tab="feats">Feats & Cyberware</div>
      <div class="tab" data-tab="abilities">Abilities & Spells</div>
      <div class="tab" data-tab="eq">EQ & Notes</div>
      <div class="tab" data-tab="combat">Combat Interface</div>
    </div>

    <div class="panel">
      <div class="panel-grid">

        <!-- LEFT MAIN -->
        <div>
          <!-- CORE TAB -->
          <div class="tab-panel" id="tab-core">
            <div class="card">
              <h3>Identity</h3>
              <div class="row"><label>Character Name</label><input id="name" type="text"></div>
              <div class="row"><label>Player</label><input id="player" type="text"></div>
              <div class="row"><label>Race</label><input id="race" type="text"></div>
              <div class="row"><label>Class</label><input id="class_text" type="text"></div>
              <div class="row"><label>Level</label><input id="level" type="number" min="1" value="1"></div>
              <div class="row"><label>Background</label><input id="background" type="text"></div>
              <div class="row"><label>Faction</label><input id="faction" type="text"></div>
              <div class="row"><label>Alignment</label><input id="alignment" type="text"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attributes & Saving Throws</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="attr-box">
                  <div><input id="attr_STR" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/></div>
                  <div class="label">STR</div>
                  <div class="save-row"><input id="save_prof_STR" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_STR">+0</div></div>
                </div>

                <div class="attr-box">
                  <div style="display:flex;align-items:center;gap:6px;justify-content:center"><input id="attr_DEX" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/><div class="inline-roll" title="Roll Initiative"><div class="dice-hex" data-roll="initiative" id="init_roll_btn" aria-label="Roll Initiative" role="button" tabindex="0"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                  <div class="label">DEX</div>
                  <div class="save-row"><input id="save_prof_DEX" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_DEX">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CON" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/></div>
                  <div class="label">CON</div>
                  <div class="save-row"><input id="save_prof_CON" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CON">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_INT" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/></div>
                  <div class="label">INT</div>
                  <div class="save-row"><input id="save_prof_INT" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_INT">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_WIS" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/></div>
                  <div class="label">WIS</div>
                  <div class="save-row"><input id="save_prof_WIS" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_WIS">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CHA" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700"/></div>
                  <div class="label">CHA</div>
                  <div class="save-row"><input id="save_prof_CHA" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CHA">+0</div></div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Skills</h3>
              <p class="muted">Check Prof / Expertise — bonuses auto-calc from ability mods and proficiency. Click the cyan hex to roll a skill check.</p>
              <div style="margin-top:8px">
                <div class="skill-row"><label>Athletics (STR)</label><div class="checkbox-inline"><input id="prof_athletics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_athletics" type="checkbox">Expertise</div><div class="skill-bonus" id="bonus_athletics">+0</div><div class="inline-roll" title="Roll Athletics"><div class="dice-hex" data-roll="skill:athletics" title="Roll Athletics"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>

                <div class="skill-row"><label>Acrobatics (DEX)</label><div class="checkbox-inline"><input id="prof_acrobatics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_acrobatics" type="checkbox">Expertise</div><div class="skill-bonus" id="bonus_acrobatics">+0</div><div class="inline-roll" title="Roll Acrobatics"><div class="dice-hex" data-roll="skill:acrobatics"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Sleight of Hand (DEX)</label><div class="checkbox-inline"><input id="prof_sleight" type="checkbox"></div><div class="checkbox-inline"><input id="exp_sleight" type="checkbox"></div><div class="skill-bonus" id="bonus_sleight">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:sleight"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Stealth (DEX)</label><div class="checkbox-inline"><input id="prof_stealth" type="checkbox"></div><div class="checkbox-inline"><input id="exp_stealth" type="checkbox"></div><div class="skill-bonus" id="bonus_stealth">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:stealth"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Driving (DEX)</label><div class="checkbox-inline"><input id="prof_driving" type="checkbox"></div><div class="checkbox-inline"><input id="exp_driving" type="checkbox"></div><div class="skill-bonus" id="bonus_driving">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:driving"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>

                <div class="skill-row"><label>Arcana (INT)</label><div class="checkbox-inline"><input id="prof_arcana" type="checkbox"></div><div class="checkbox-inline"><input id="exp_arcana" type="checkbox"></div><div class="skill-bonus" id="bonus_arcana">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:arcana"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>History (INT)</label><div class="checkbox-inline"><input id="prof_history" type="checkbox"></div><div class="checkbox-inline"><input id="exp_history" type="checkbox"></div><div class="skill-bonus" id="bonus_history">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:history"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Investigation (INT)</label><div class="checkbox-inline"><input id="prof_investigation" type="checkbox"></div><div class="checkbox-inline"><input id="exp_investigation" type="checkbox"></div><div class="skill-bonus" id="bonus_investigation">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:investigation"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Nature (INT)</label><div class="checkbox-inline"><input id="prof_nature" type="checkbox"></div><div class="checkbox-inline"><input id="exp_nature" type="checkbox"></div><div class="skill-bonus" id="bonus_nature">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:nature"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Religion (INT)</label><div class="checkbox-inline"><input id="prof_religion" type="checkbox"></div><div class="checkbox-inline"><input id="exp_religion" type="checkbox"></div><div class="skill-bonus" id="bonus_religion">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:religion"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Technology (INT)</label><div class="checkbox-inline"><input id="prof_technology" type="checkbox"></div><div class="checkbox-inline"><input id="exp_technology" type="checkbox"></div><div class="skill-bonus" id="bonus_technology">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:technology"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>

                <div class="skill-row"><label>Animal Handling (WIS)</label><div class="checkbox-inline"><input id="prof_animal" type="checkbox"></div><div class="checkbox-inline"><input id="exp_animal" type="checkbox"></div><div class="skill-bonus" id="bonus_animal">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:animal"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Insight (WIS)</label><div class="checkbox-inline"><input id="prof_insight" type="checkbox"></div><div class="checkbox-inline"><input id="exp_insight" type="checkbox"></div><div class="skill-bonus" id="bonus_insight">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:insight"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Medicine (WIS)</label><div class="checkbox-inline"><input id="prof_medicine" type="checkbox"></div><div class="checkbox-inline"><input id="exp_medicine" type="checkbox"></div><div class="skill-bonus" id="bonus_medicine">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:medicine"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Perception (WIS)</label><div class="checkbox-inline"><input id="prof_perception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_perception" type="checkbox"></div><div class="skill-bonus" id="bonus_perception">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:perception"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Survival (WIS)</label><div class="checkbox-inline"><input id="prof_survival" type="checkbox"></div><div class="checkbox-inline"><input id="exp_survival" type="checkbox"></div><div class="skill-bonus" id="bonus_survival">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:survival"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>

                <div class="skill-row"><label>Deception (CHA)</label><div class="checkbox-inline"><input id="prof_deception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_deception" type="checkbox"></div><div class="skill-bonus" id="bonus_deception">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:deception"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Intimidation (CHA)</label><div class="checkbox-inline"><input id="prof_intimidation" type="checkbox"></div><div class="checkbox-inline"><input id="exp_intimidation" type="checkbox"></div><div class="skill-bonus" id="bonus_intimidation">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:intimidation"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Performance (CHA)</label><div class="checkbox-inline"><input id="prof_performance" type="checkbox"></div><div class="checkbox-inline"><input id="exp_performance" type="checkbox"></div><div class="skill-bonus" id="bonus_performance">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:performance"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
                <div class="skill-row"><label>Persuasion (CHA)</label><div class="checkbox-inline"><input id="prof_persuasion" type="checkbox"></div><div class="checkbox-inline"><input id="exp_persuasion" type="checkbox"></div><div class="skill-bonus" id="bonus_persuasion">+0</div><div class="inline-roll"><div class="dice-hex" data-roll="skill:persuasion"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Sanity & Corruption</h3>
              <div class="row"><label>Sanity (cur / max)</label><input id="sanity" placeholder="12 / 20"></div>
              <div class="row"><label>Corruption (cur / max)</label><input id="corruption" placeholder="0 / 20"></div>
              <div style="margin-top:8px"><label>Notes</label><textarea id="sanity_notes" placeholder="Sanity scars, mutations, notes..."></textarea></div>
            </div>

          </div>

          <!-- FEATS & CYBERWARE TAB -->
          <div class="tab-panel" id="tab-feats" style="display:none">
            <div class="card">
              <h3>-- Feats --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_feat_name" placeholder="Feat name"/>
                <button id="addFeat">Add</button>
              </div>
              <div class="list-wrap" id="feats_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>-- Cyberware --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_cyber_name" placeholder="Cyberware name"/>
                <button id="addCyber">Add</button>
              </div>
              <div class="list-wrap" id="cyber_list"></div>
            </div>
          </div>

          <!-- ABILITIES & SPELLS TAB -->
          <div class="tab-panel" id="tab-abilities" style="display:none">
            <div class="card">
              <h3>Abilities</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_ability_name" placeholder="Ability name"/>
                <button id="addAbility">Add</button>
              </div>
              <div class="list-wrap" id="abilities_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Spells</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_spell_name" placeholder="Spell name"/>
                <input id="new_spell_level" style="width:70px" placeholder="Lvl"/>
                <button id="addSpell">Add</button>
              </div>
              <div class="list-wrap" id="spells_list"></div>
            </div>
          </div>

          <!-- EQ & NOTES TAB -->
          <div class="tab-panel" id="tab-eq" style="display:none">
            <div class="card">
              <h3>Equipment</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_equip" placeholder="Item name (single-line)"/>
                <button id="addEquip">Add</button>
              </div>
              <div class="list-wrap" id="equip_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Vehicles</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_vehicle_name" placeholder="Vehicle name"/>
                <button id="addVehicle">Add</button>
              </div>
              <div class="list-wrap" id="vehicles_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Notes</h3>
              <textarea id="notes" placeholder="General notes, campaign hooks, NPCs..."></textarea>
            </div>
          </div>

          <!-- COMBAT INTERFACE TAB -->
          <div class="tab-panel" id="tab-combat" style="display:none">
            <div class="card">
              <h3>Combat Interface</h3>
              <div class="row"><label>Armor Class</label><input id="ac" type="text"></div>
              <div class="row"><label>Initiative</label><input id="init" type="text" readonly><div class="inline-roll"><div class="dice-hex" data-roll="initiative_inline" title="Roll Initiative (alt)"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div></div>
              <div class="row"><label>Speed</label><input id="speed" type="text"></div>
              <div class="row"><label>Proficiency</label><input id="prof_display" type="text" readonly></div>
              <div class="row"><label>Max HP</label><input id="hp_max" type="number"></div>
              <div class="row"><label>Current HP</label><input id="hp_cur" type="number"></div>
              <div class="row"><label>Temp HP</label><input id="hp_temp" type="number"></div>
              <div class="row"><label>Hit Dice</label><input id="hit_dice" type="text"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Resistances & Immunities</h3>
              <textarea id="resistances" placeholder="List resistances, immunities, notes..."></textarea>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attacks</h3>
              <p class="muted">Add named attacks with attack/damage formulas. Use inline hex to roll attack or damage.</p>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_attack_name" placeholder="Attack name"/>
                <input id="new_attack_tohit" style="width:120px" placeholder="To-Hit (e.g. +5 or 1d20+3)"/>
                <input id="new_attack_damage" style="width:120px" placeholder="Damage (e.g. 1d8+2)"/>
                <button id="addAttack">Add</button>
              </div>
              <div class="list-wrap" id="attacks_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Webhook / Settings</h3>
              <div class="row"><label>Discord Webhook URL</label><input id="webhook_url" placeholder="https://discord.com/api/webhooks/..."></div>
              <div class="row"><label>Roll Log Options</label>
                <select id="rolllog_fade">
                  <option value="5">Auto-fade 5s</option>
                  <option value="10">Auto-fade 10s</option>
                  <option value="0">Never auto-fade</option>
                </select>
              </div>
            </div>

          </div>

        </div>

        <!-- RIGHT: snapshot & quick -->
        <div>
          <div class="card snapshot">
            <h3>Snapshot</h3>
            <div class="row"><strong>Name</strong><div id="snap_name" class="muted">—</div></div>
            <div class="row"><strong>Class / Level</strong><div id="snap_class" class="muted">—</div></div>
            <div class="row"><strong>HP</strong><div id="snap_hp" class="muted">0 / 0</div></div>
            <div class="row"><strong>AC</strong><div id="snap_ac" class="muted">—</div></div>
            <div class="row"><strong>Sanity / Corr.</strong><div id="snap_sanity" class="muted">—</div></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Quick Actions</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="downloadJSON">Download JSON</button>
              <button id="loadJSON">Load JSON</button>
              <button id="clearLocal">Clear Local</button>
            </div>
            <p class="muted" style="margin-top:10px">Autosaves as you type. Export to move or backup characters.</p>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Help</h3>
            <p class="muted" style="font-size:13px;margin:0">This sheet stores data locally in your browser. Use Export/Import to transfer characters.</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Roll Log Overlay -->
  <div id="rollLog" class="roll-log collapsed" aria-hidden="true">
    <div class="head">
      <div class="dice-hex" id="rollLogToggle" title="Toggle Roll Log"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div>
      <div style="flex:1"><strong style="color:#eaffff">Roll Log</strong><div style="font-size:11px;color:#9fdffb">Recent rolls and webhook activity</div></div>
      <div><button class="clear" id="clearRolls">Clear</button></div>
    </div>
    <div class="entries" id="rollEntries"></div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:space-between">
      <div class="muted" id="rollStatus">Idle</div>
      <div><button id="openRolls">Open</button></div>
    </div>
  </div>

<script>
/* -------------------------
   Constants & helpers
   ------------------------- */
const STORAGE_KEY = 'cybercraft_sheet_v_final';
const ROLLSTATE_KEY = 'cybercraft_rollstate_v3';
const SKILLS = {
  athletics:'STR', acrobatics:'DEX', sleight:'DEX', stealth:'DEX', driving:'DEX',
  arcana:'INT', history:'INT', investigation:'INT', nature:'INT', religion:'INT', technology:'INT',
  animal:'WIS', insight:'WIS', medicine:'WIS', perception:'WIS', survival:'WIS',
  deception:'CHA', intimidation:'CHA', performance:'CHA', persuasion:'CHA'
};
function abilityMod(score){ const s=parseInt(score)||0; return Math.floor((s-10)/2); }
function proficiencyByLevel(lvl){ lvl = parseInt(lvl)||1; return Math.ceil(lvl/4)+1; }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------------
   Tab handling
   ------------------------- */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
    document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
  });
});

/* -------------------------
   Dynamic lists + rendering helpers
   ------------------------- */
function renderList(containerId, items, templateFn){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  items.forEach((it,i)=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = templateFn(it,i);
    wrap.appendChild(el);
  });
}

/* Feats */
window._feats = window._feats || [];
function renderFeats(){ renderList('feats_list', window._feats, (f,i)=>`
  <div style="flex:1">
    <input class="feat_name" data-i="${i}" value="${escapeHtml(f.name||'')}" placeholder="Feat name"/>
    <textarea class="feat_desc" data-i="${i}" placeholder="Description">${escapeHtml(f.desc||'')}</textarea>
  </div>
  <div><button class="remove_feat" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addFeat').addEventListener('click', ()=>{
  const name = document.getElementById('new_feat_name').value.trim(); if(!name) return alert('Enter feat name');
  window._feats.push({name:name,desc:''}); document.getElementById('new_feat_name').value=''; renderFeats(); saveToStorage();
});
document.getElementById('feats_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_feat')){ const i=parseInt(e.target.dataset.i); window._feats.splice(i,1); renderFeats(); saveToStorage(); }
});
document.getElementById('feats_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('feat_name')) window._feats[i].name = e.target.value;
  if(cls.includes('feat_desc')) window._feats[i].desc = e.target.value;
  saveToStorage();
});

/* Cyberware */
window._cyber = window._cyber || [];
function renderCyber(){ renderList('cyber_list', window._cyber, (c,i)=>`
  <div style="flex:1">
    <input class="cyber_name" data-i="${i}" value="${escapeHtml(c.name||'')}" placeholder="Cyberware name"/>
    <textarea class="cyber_desc" data-i="${i}" placeholder="Description (optional)">${escapeHtml(c.desc||'')}</textarea>
  </div>
  <div><button class="remove_cyber" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addCyber').addEventListener('click', ()=>{
  const name=document.getElementById('new_cyber_name').value.trim(); if(!name) return alert('Enter cyberware name');
  window._cyber.push({name:name,desc:''}); document.getElementById('new_cyber_name').value=''; renderCyber(); saveToStorage();
});
document.getElementById('cyber_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_cyber')){ const i=parseInt(e.target.dataset.i); window._cyber.splice(i,1); renderCyber(); saveToStorage(); }
});
document.getElementById('cyber_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('cyber_name')) window._cyber[i].name = e.target.value;
  if(cls.includes('cyber_desc')) window._cyber[i].desc = e.target.value;
  saveToStorage();
});

/* Abilities */
window._abilities = window._abilities || [];
function renderAbilities(){ renderList('abilities_list', window._abilities, (a,i)=>`
  <div style="flex:1">
    <input class="ability_name" data-i="${i}" value="${escapeHtml(a.name||'')}" placeholder="Ability name"/>
    <textarea class="ability_desc" data-i="${i}" placeholder="Description">${escapeHtml(a.desc||'')}</textarea>
  </div>
  <div><button class="remove_ability" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addAbility').addEventListener('click', ()=>{
  const name=document.getElementById('new_ability_name').value.trim(); if(!name) return alert('Enter ability name');
  window._abilities.push({name:name,desc:''}); document.getElementById('new_ability_name').value=''; renderAbilities(); saveToStorage();
});
document.getElementById('abilities_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_ability')){ const i=parseInt(e.target.dataset.i); window._abilities.splice(i,1); renderAbilities(); saveToStorage(); }
});
document.getElementById('abilities_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('ability_name')) window._abilities[i].name = e.target.value;
  if(cls.includes('ability_desc')) window._abilities[i].desc = e.target.value;
  saveToStorage();
});

/* Spells */
window._spells = window._spells || [];
function renderSpells(){ renderList('spells_list', window._spells, (s,i)=>`
  <div style="flex:1">
    <input class="spell_name" data-i="${i}" value="${escapeHtml(s.name||'')}" placeholder="Spell name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="spell_level" data-i="${i}" style="width:70px" value="${escapeHtml(s.level||'')}" placeholder="Level"/>
      <input class="spell_time" data-i="${i}" style="flex:1" value="${escapeHtml(s.time||'')}" placeholder="Casting time / Range / Duration"/>
    </div>
    <textarea class="spell_desc" data-i="${i}" placeholder="Details">${escapeHtml(s.desc||'')}</textarea>
  </div>
  <div><button class="remove_spell" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addSpell').addEventListener('click', ()=>{
  const name=document.getElementById('new_spell_name').value.trim(); const lvl=document.getElementById('new_spell_level').value.trim();
  if(!name) return alert('Enter spell name');
  window._spells.push({name:name,level:lvl,time:'',desc:''}); document.getElementById('new_spell_name').value=''; document.getElementById('new_spell_level').value=''; renderSpells(); saveToStorage();
});
document.getElementById('spells_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_spell')){ const i=parseInt(e.target.dataset.i); window._spells.splice(i,1); renderSpells(); saveToStorage(); }
});
document.getElementById('spells_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('spell_name')) window._spells[i].name = e.target.value;
  if(cls.includes('spell_level')) window._spells[i].level = e.target.value;
  if(cls.includes('spell_time')) window._spells[i].time = e.target.value;
  if(cls.includes('spell_desc')) window._spells[i].desc = e.target.value;
  saveToStorage();
});

/* Equipment (single-line) */
window._equip = window._equip || [];
function renderEquip(){ renderList('equip_list', window._equip, (it,i)=>`
  <div style="flex:1">
    <input class="equip_item" data-i="${i}" value="${escapeHtml(it||'')}" placeholder="Item name"/>
  </div>
  <div><button class="remove_equip" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addEquip').addEventListener('click', ()=>{
  const name=document.getElementById('new_equip').value.trim(); if(!name) return alert('Enter item'); window._equip.push(name); document.getElementById('new_equip').value=''; renderEquip(); saveToStorage();
});
document.getElementById('equip_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_equip')){ const i=parseInt(e.target.dataset.i); window._equip.splice(i,1); renderEquip(); saveToStorage(); }
});
document.getElementById('equip_list').addEventListener('input',(e)=>{
  if(e.target.classList.contains('equip_item')){ const i=parseInt(e.target.dataset.i); window._equip[i] = e.target.value; saveToStorage(); }
});

/* Vehicles */
window._vehicles = window._vehicles || [];
function renderVehicles(){ renderList('vehicles_list', window._vehicles, (v,i)=>`
  <div style="flex:1">
    <input class="veh_name" data-i="${i}" value="${escapeHtml(v.name||'')}" placeholder="Vehicle name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="veh_type" data-i="${i}" style="width:120px" value="${escapeHtml(v.type||'')}" placeholder="Type"/>
      <input class="veh_speed" data-i="${i}" style="width:100px" value="${escapeHtml(v.speed||'')}" placeholder="Speed"/>
      <input class="veh_ac" data-i="${i}" style="width:80px" value="${escapeHtml(v.ac||'')}" placeholder="AC"/>
    </div>
    <textarea class="veh_desc" data-i="${i}" placeholder="Upgrades / Notes">${escapeHtml(v.desc||'')}</textarea>
  </div>
  <div><button class="remove_vehicle" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addVehicle').addEventListener('click', ()=>{
  const name=document.getElementById('new_vehicle_name').value.trim(); if(!name) return alert('Enter vehicle name');
  window._vehicles.push({name:name,type:'',speed:'',ac:'',desc:''}); document.getElementById('new_vehicle_name').value=''; renderVehicles(); saveToStorage();
});
document.getElementById('vehicles_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_vehicle')){ const i=parseInt(e.target.dataset.i); window._vehicles.splice(i,1); renderVehicles(); saveToStorage(); }
});
document.getElementById('vehicles_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('veh_name')) window._vehicles[i].name = e.target.value;
  if(cls.includes('veh_type')) window._vehicles[i].type = e.target.value;
  if(cls.includes('veh_speed')) window._vehicles[i].speed = e.target.value;
  if(cls.includes('veh_ac')) window._vehicles[i].ac = e.target.value;
  if(cls.includes('veh_desc')) window._vehicles[i].desc = e.target.value;
  saveToStorage();
});

/* Attacks manager */
window._attacks = window._attacks || [];
function renderAttacks(){
  const wrap = document.getElementById('attacks_list'); wrap.innerHTML = '';
  window._attacks.forEach((a,i)=>{
    const row = document.createElement('div'); row.className='attack-row';
    row.innerHTML = `
      <input class="attack_name" data-i="${i}" value="${escapeHtml(a.name)}" placeholder="Name" style="width:140px"/>
      <input class="attack_tohit" data-i="${i}" value="${escapeHtml(a.tohit)}" placeholder="To-Hit" style="width:110px"/>
      <input class="attack_damage" data-i="${i}" value="${escapeHtml(a.damage)}" placeholder="Damage" style="width:110px"/>
      <div class="attack-actions">
        <div class="inline-roll" title="Roll Attack"><div class="dice-hex roll-attack" data-i="${i}" data-type="attack"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div>
        <div class="inline-roll" title="Roll Damage"><div class="dice-hex roll-damage" data-i="${i}" data-type="damage"><svg viewBox="0 0 24 24"><polygon points="12,2 3,8 3,16 12,22 21,16 21,8" fill="none" stroke="var(--dice-color)" stroke-width="1.6" stroke-linejoin="round"/><circle cx="12" cy="12" r="2" fill="var(--dice-color)"/></svg></div></div>
        <button class="remove_attack" data-i="${i}">Remove</button>
      </div>
    `;
    wrap.appendChild(row);
  });
}
document.getElementById('addAttack').addEventListener('click', ()=>{
  const n=document.getElementById('new_attack_name').value.trim();
  const t=document.getElementById('new_attack_tohit').value.trim();
  const d=document.getElementById('new_attack_damage').value.trim();
  if(!n) return alert('Enter attack name');
  window._attacks.push({name:n,tohit:t,damage:d});
  document.getElementById('new_attack_name').value=''; document.getElementById('new_attack_tohit').value=''; document.getElementById('new_attack_damage').value='';
  renderAttacks(); saveToStorage();
});
document.getElementById('attacks_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_attack')){ const i=parseInt(e.target.dataset.i); window._attacks.splice(i,1); renderAttacks(); saveToStorage(); }
});
document.getElementById('attacks_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('attack_name')) window._attacks[i].name = e.target.value;
  if(cls.includes('attack_tohit')) window._attacks[i].tohit = e.target.value;
  if(cls.includes('attack_damage')) window._attacks[i].damage = e.target.value;
  saveToStorage();
});

/* -------------------------
   Save / Load
   ------------------------- */
function gatherState(){
  const state = {};
  const ids = [
    'name','player','race','class_text','level','background','faction','alignment',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','init','speed','prof_display','hp_max','hp_cur','hp_temp','hit_dice',
    'sanity','corruption','sanity_notes','notes','resistances','webhook_url'
  ];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    state[id] = (el.type==='checkbox') ? el.checked : el.value;
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=document.getElementById('prof_'+s), e=document.getElementById('exp_'+s);
    state['prof_'+s] = p ? p.checked : false;
    state['exp_'+s] = e ? e.checked : false;
  });
  state.feats = window._feats||[]; state.cyber = window._cyber||[]; state.abilities = window._abilities||[]; state.spells = window._spells||[];
  state.equip = window._equip||[]; state.vehicles = window._vehicles||[]; state.attacks = window._attacks||[]; state.rollstate = loadRollState();
  return state;
}
function applyState(state){
  if(!state) return;
  const ids = [
    'name','player','race','class_text','level','background','faction','alignment',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','init','speed','prof_display','hp_max','hp_cur','hp_temp','hit_dice',
    'sanity','corruption','sanity_notes','notes','resistances','webhook_url'
  ];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el || state[id]===undefined) return;
    if(el.type==='checkbox') el.checked = !!state[id]; else el.value = state[id];
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=document.getElementById('prof_'+s); if(p) p.checked = !!state['prof_'+s];
    const e=document.getElementById('exp_'+s); if(e) e.checked = !!state['exp_'+s];
  });
  window._feats = state.feats||[]; window._cyber = state.cyber||[]; window._abilities = state.abilities||[]; window._spells = state.spells||[];
  window._equip = state.equip||[]; window._vehicles = state.vehicles||[]; window._attacks = state.attacks||[];
  renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
  if(state.rollstate) applyRollState(state.rollstate);
  updateAllCalculations(); updateSnapshot();
}
function saveToStorage(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(gatherState())); }catch(e){console.error(e);} }
function loadFromStorage(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; applyState(JSON.parse(raw)); }catch(e){console.error(e);} }

/* -------------------------
   Roll state (log collapse, entries)
   ------------------------- */
function loadRollState(){ try{ const raw = localStorage.getItem(ROLLSTATE_KEY); return raw?JSON.parse(raw):{collapsed:true,entries:[]}; }catch(e){return {collapsed:true,entries:[]};} }
function saveRollState(state){ try{ localStorage.setItem(ROLLSTATE_KEY, JSON.stringify(state)); }catch(e){} }
function applyRollState(state){
  const log = document.getElementById('rollLog');
  if(state.collapsed) log.classList.add('collapsed'), log.setAttribute('aria-hidden','true'); else log.classList.remove('collapsed'), log.setAttribute('aria-hidden','false');
  const entries = state.entries || [];
  const wrap = document.getElementById('rollEntries'); wrap.innerHTML='';
  entries.slice().reverse().forEach(en => appendRollEntry(en,false));
}

/* Roll helpers */
function rollDie(sides){ return 1 + Math.floor(Math.random()*sides); }
function parseDiceExpr(expr){
  // supports "NdM + K" and "dM" and "K"
  expr = String(expr||'').replace(/\s+/g,'');
  if(!expr) return null;
  const parts = expr.split('+').map(p=>p.replace(/\-/,'+-'));
  // naive parse: support multiple terms separated by +
  const tokens = [];
  let re = /([0-9]*)d([0-9]+)|([+-]?[0-9]+)/gi;
  let m;
  while((m=re.exec(expr))!==null){
    if(m[2]) tokens.push({type:'dice',n: parseInt(m[1])||1, sides: parseInt(m[2])});
    else if(m[3]) tokens.push({type:'const',v: parseInt(m[3])});
  }
  return tokens;
}
function rollFromExpr(expr, options){
  // options: {adv:0/1/-1} adv=1 advantage, -1 disadvantage
  expr = String(expr||'').trim();
  if(!expr) return {total:0,details:'',rolls:[]};
  // handle patterns like "1d20+3" or "+3" or "d20+3"
  // detect if includes "1d20" for advantage/dis
  const tokens = parseDiceExpr(expr);
  if(!tokens || tokens.length===0){
    // try parse as single number
    const v = parseInt(expr)||0;
    return {total:v,details:expr,rolls:[]};
  }
  // if any dice with sides 20 and adv requested, perform advantage on d20 terms
  let total = 0; const detailsParts = []; const rolls = [];
  tokens.forEach(tok=>{
    if(tok.type==='dice'){
      if(tok.sides===20 && Math.abs(options.adv || 0)===1){
        // advantage/disadv on each d20 term
        const r1 = rollDie(20); const r2 = rollDie(20);
        const pick = (options.adv===1) ? Math.max(r1,r2) : Math.min(r1,r2);
        rolls.push({dice:`${tok.n}d${tok.sides}`,component:`adv(${r1},${r2})->${pick}`});
        total += pick * tok.n; // note: if tok.n>1 this is simplified: assume n=1 for d20 adv usage normally
      } else {
        let sum=0; let subrolls=[];
        for(let i=0;i<tok.n;i++){ const r = rollDie(tok.sides); sum+=r; subrolls.push(r); }
        rolls.push({dice:`${tok.n}d${tok.sides}`,component:subrolls.join(',')});
        total += sum;
      }
    } else if(tok.type==='const'){ total += tok.v; rolls.push({dice:'const',component: tok.v});}
  });
  return {total,details:expr,rolls};
}

/* Unified roll function: roll(type, formula, opts) */
function doRoll({type='Generic', formula='', bonus=0, adv=0, sourceName=''}){
  // adv: 0 none, 1 advantage, -1 disadvantage
  // first parse formula for d20-based to-hit behavior if formula has "d20"
  const parsed = parseDiceExpr(formula);
  let result;
  if(parsed && parsed.some(t=>t.type==='dice' && t.sides===20)){
    // roll d20 terms with adv/dis if requested
    // simple approach: evaluate each token using rollFromExpr with adv param
    result = rollFromExpr(formula,{adv});
  } else {
    result = rollFromExpr(formula,{adv});
  }
  // add any bonus passed separately
  if(bonus) result.total += bonus;
  // assemble a message and push to log
  const entry = {
    ts: (new Date()).toISOString(),
    title: `${type}${ sourceName ? ' — '+sourceName : '' }`,
    result: result.total,
    details: `Formula: ${formula}${bonus? ' | bonus '+bonus: ''}${adv===1? ' | adv': adv===-1? ' | dis':''}`,
    raw: result
  };
  pushRollEntry(entry);
  // attempt webhook
  const webhook = (document.getElementById('webhook_url')||{}).value || '';
  if(webhook && webhook.startsWith('http')){
    sendWebhook(webhook, entry);
  }
  return entry;
}

/* --------------------------------------------------
   Roll Log UI / storage
   -------------------------------------------------- */
function appendRollEntry(entry, saveState=true){
  const wrap = document.getElementById('rollEntries');
  const el = document.createElement('div'); el.className='roll-item';
  el.innerHTML = `<div class="title">${escapeHtml(entry.title)}</div>
    <div style="font-size:13px;margin-top:6px"><strong>${entry.result}</strong> — <span style="opacity:.9">${escapeHtml(entry.details)}</span></div>
    <div style="font-size:11px;color:#8fdff8;margin-top:6px">${new Date(entry.ts).toLocaleString()}</div>`;
  wrap.insertBefore(el, wrap.firstChild);
  // save state
  if(saveState){
    const s = loadRollState(); s.entries = s.entries || [];
    s.entries.push(entry);
    if(s.entries.length>200) s.entries = s.entries.slice(-200);
    saveRollState(s);
  }
  // make visible
  const log = document.getElementById('rollLog');
  log.classList.remove('collapsed'); log.setAttribute('aria-hidden','false');
  const rs = loadRollState(); rs.collapsed=false; saveRollState(rs);
  // schedule fade if configured
  scheduleAutoFade();
}

function pushRollEntry(entry){
  appendRollEntry(entry,true);
  document.getElementById('rollStatus').textContent = `Last roll: ${entry.title} = ${entry.result}`;
}

/* webhook posting */
async function sendWebhook(url, entry){
  try{
    const payload = {
      embeds: [{
        title: `Cybercraft 5e — ${ (document.getElementById('name')||{}).value || 'Unknown' }`,
        color: parseInt('00' + ( (document.getElementById('name')? '': '0') ), 16), // fallback
        fields: [
          { name: 'Roll Type', value: entry.title, inline: true },
          { name: 'Result', value: String(entry.result), inline: true },
          { name: 'Details', value: entry.details, inline: false }
        ],
        timestamp: entry.ts
      }]
    };
    // override color with dice color hex to int
    const hex = getComputedStyle(document.documentElement).getPropertyValue('--dice-color').trim() || '#00D1FF';
    payload.embeds[0].color = parseInt(hex.replace('#',''),16);
    await fetch(url, { method:'POST', body: JSON.stringify(payload), headers: {'Content-Type':'application/json'} });
    document.getElementById('rollStatus').textContent = 'Webhook sent';
  }catch(err){
    document.getElementById('rollStatus').textContent = 'Webhook failed';
    console.error('webhook err',err);
  }
}

/* Roll log controls */
document.getElementById('rollLogToggle').addEventListener('click', ()=>{
  const log = document.getElementById('rollLog'); const cur = log.classList.contains('collapsed');
  if(cur){ log.classList.remove('collapsed'); log.setAttribute('aria-hidden','false'); } else { log.classList.add('collapsed'); log.setAttribute('aria-hidden','true'); }
  const s = loadRollState(); s.collapsed = log.classList.contains('collapsed'); saveRollState(s);
});
document.getElementById('clearRolls').addEventListener('click', ()=>{
  if(!confirm('Clear roll history?')) return;
  const wrap = document.getElementById('rollEntries'); wrap.innerHTML=''; const s = loadRollState(); s.entries = []; saveRollState(s);
});
document.getElementById('openRolls').addEventListener('click', ()=>{ const log = document.getElementById('rollLog'); log.classList.remove('collapsed'); log.setAttribute('aria-hidden','false'); const s = loadRollState(); s.collapsed=false; saveRollState(s); });

let autoFadeTimer = null;
function scheduleAutoFade(){
  const sel = document.getElementById('rolllog_fade'); if(!sel) return;
  const v = parseInt(sel.value);
  if(v<=0) return;
  if(autoFadeTimer) clearTimeout(autoFadeTimer);
  autoFadeTimer = setTimeout(()=>{ const log = document.getElementById('rollLog'); log.classList.add('collapsed'); log.setAttribute('aria-hidden','true'); const s = loadRollState(); s.collapsed=true; saveRollState(s); }, v*1000);
}

/* -------------------------
   Bindings for inline roll buttons (skills, initiative, attacks)
   ------------------------- */
document.body.addEventListener('click',(e)=>{
  const el = e.target.closest('.dice-hex');
  if(!el) return;
  // button clicked, animate
  el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),420);
  const dr = el.dataset.roll;
  if(dr){
    if(dr.startsWith('skill:')){
      const skill = dr.split(':')[1];
      const bonusText = document.getElementById('bonus_'+skill);
      const bonus = parseInt((bonusText||{}).textContent.replace('+',''))||0;
      const entry = doRoll({type: `Skill: ${skill}`, formula:'1d20', bonus, adv:0, sourceName: (document.getElementById('name')||{}).value });
      return;
    }
    if(dr==='initiative' || dr==='initiative_inline'){
      const dex = parseInt(document.getElementById('attr_DEX').value)||10;
      const imod = abilityMod(dex);
      const entry = doRoll({type:'Initiative', formula:'1d20', bonus: imod, adv:0, sourceName:(document.getElementById('name')||{}).value});
      document.getElementById('init').value = (entry.result>=0?'+':'') + entry.result;
      return;
    }
  }
  // attack/damage specialized buttons
  if(el.classList.contains('roll-attack') || el.classList.contains('roll-damage')){
    const i = parseInt(el.dataset.i);
    if(isNaN(i) || !window._attacks[i]) return;
    const atk = window._attacks[i];
    if(el.classList.contains('roll-attack')){
      // to-hit can be like "+5" or "1d20+3"
      const formula = atk.tohit && atk.tohit.trim()!=='' ? atk.tohit : '1d20';
      const entry = doRoll({type:`Attack — ${atk.name}`, formula: formula, bonus:0, adv:0, sourceName:(document.getElementById('name')||{}).value});
      return;
    } else {
      const formula = atk.damage && atk.damage.trim()!=='' ? atk.damage : '1d6';
      const entry = doRoll({type:`Damage — ${atk.name}`, formula: formula, bonus:0, adv:0, sourceName:(document.getElementById('name')||{}).value});
      return;
    }
  }
});

/* -------------------------
   Calculations: saves, skills, init
   ------------------------- */
function updateAllCalculations(){
  const level = parseInt(document.getElementById('level').value) || 1;
  const prof = proficiencyByLevel(level);
  document.getElementById('prof_display').value = (prof>=0?'+':'') + prof;

  ['STR','DEX','CON','INT','WIS','CHA'].forEach(ab=>{
    const score = parseInt(document.getElementById('attr_'+ab).value)||0;
    const mod = abilityMod(score);
    const profCheck = document.getElementById('save_prof_'+ab).checked;
    const total = mod + (profCheck ? prof : 0);
    document.getElementById('save_bonus_'+ab).textContent = (total>=0?'+':'') + total;
  });

  Object.keys(SKILLS).forEach(s=>{
    const ab = SKILLS[s];
    const score = parseInt(document.getElementById('attr_'+ab).value)||0;
    const abmod = abilityMod(score);
    const profCheck = document.getElementById('prof_'+s) ? document.getElementById('prof_'+s).checked : false;
    const expCheck = document.getElementById('exp_'+s) ? document.getElementById('exp_'+s).checked : false;
    let bonus = abmod;
    if(profCheck) bonus += prof * (expCheck ? 2 : 1);
    const el = document.getElementById('bonus_'+s);
    if(el) el.textContent = (bonus>=0?'+':'') + bonus;
  });

  // Initiative from DEX mod
  const dex = parseInt(document.getElementById('attr_DEX').value)||0;
  const imod = abilityMod(dex);
  document.getElementById('init').value = (imod>=0?'+':'') + imod;

  saveToStorage();
  updateSnapshot();
}

/* -------------------------
   Snapshot + listeners
   ------------------------- */
function updateSnapshot(){
  document.getElementById('snap_name').textContent = document.getElementById('name').value || '—';
  document.getElementById('snap_class').textContent = (document.getElementById('class_text').value||'—') + ' / ' + (document.getElementById('level').value||'—');
  document.getElementById('snap_hp').textContent = (document.getElementById('hp_cur').value||'0') + ' / ' + (document.getElementById('hp_max').value||'0');
  document.getElementById('snap_ac').textContent = document.getElementById('ac').value || '—';
  document.getElementById('snap_sanity').textContent = (document.getElementById('sanity').value||'—') + ' / ' + (document.getElementById('corruption').value||'—');
}

function attachListeners(){
  const watch = [
    'level','attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'sanity','corruption','hp_cur','hp_max','ac','init','notes','resistances','webhook_url'
  ];
  watch.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(el.type==='checkbox') el.addEventListener('change', updateAllCalculations);
    else el.addEventListener('input', ()=>{ if(window._calcTimer) clearTimeout(window._calcTimer); window._calcTimer=setTimeout(()=>updateAllCalculations(),180);});
  });
  Object.keys(SKILLS).forEach(s=>{
    const p=document.getElementById('prof_'+s); const e=document.getElementById('exp_'+s);
    if(p) p.addEventListener('change', updateAllCalculations);
    if(e) e.addEventListener('change', updateAllCalculations);
  });
  document.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', ()=>{
      if(window._saveTimer) clearTimeout(window._saveTimer);
      window._saveTimer = setTimeout(()=>saveToStorage(),420);
    });
  });
}

/* -------------------------
   Export / Import / Print / Clear
   ------------------------- */
document.getElementById('export').addEventListener('click', ()=>{
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw) return alert('No saved data found.');
  const blob=new Blob([raw],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=(document.getElementById('name').value||'character')+'.cyber.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', ()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const parsed=JSON.parse(r.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed)); applyState(parsed); alert('Import OK'); }catch(err){ alert('Import failed: invalid file'); } }; r.readAsText(f); }; input.click();
});
document.getElementById('print').addEventListener('click', ()=>window.print());
document.getElementById('clear').addEventListener('click', ()=>{ if(confirm('Clear local sheet data? This cannot be undone.')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
document.getElementById('downloadJSON').addEventListener('click', ()=>document.getElementById('export').click && document.getElementById('export').click());
document.getElementById('loadJSON').addEventListener('click', ()=>document.getElementById('importBtn').click && document.getElementById('importBtn').click());
document.getElementById('clearLocal').addEventListener('click', ()=>document.getElementById('clear').click && document.getElementById('clear').click());

/* -------------------------
   Boot
   ------------------------- */
attachListeners();
loadFromStorage();
renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
setTimeout(()=>{ updateAllCalculations(); updateSnapshot(); applyRollState(loadRollState()); },200);

</script>
</body>
</html>
