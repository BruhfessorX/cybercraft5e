<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cybercraft 5e — Character Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0e10;
    --panel:#141416;
    --input:#1f1f21;
    --neon:#9B30FF; /* site neon violet */
    --muted:#c6cad2;
    --glass: rgba(255,255,255,0.02);
    --accent-glow: 0 0 20px rgba(155,48,255,0.18), inset 0 0 8px rgba(0,0,0,0.35);
    --field-border: rgba(155,48,255,0.06);
    --cyan:#00d1ff;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(900px 400px at 10% 8%, rgba(155,48,255,0.02), transparent),
    linear-gradient(180deg,#080809 0%,var(--bg) 50%); color:var(--muted);
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .container{max-width:1120px;margin:20px auto;padding:18px;}

  .titlebar{display:flex;align-items:center;gap:14px;margin-bottom:12px}
  .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--neon), #5b0fbf);
    border-radius:10px;box-shadow:var(--accent-glow);display:flex;align-items:center;justify-content:center;
    font-family:Orbitron;color:#050005;font-weight:700}
  .title-text h1{margin:0;font-family:Orbitron;color:var(--neon);font-size:20px;text-shadow:0 0 10px rgba(155,48,255,0.16)}
  .title-text p{margin:0;font-size:12px;color:#aeb5c3}

  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .small{font-size:12px;padding:6px 8px}

  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);
    border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:linear-gradient(180deg, rgba(155,48,255,0.06), rgba(155,48,255,0.02));box-shadow:var(--accent-glow);color:white;border:1px solid rgba(155,48,255,0.25);transform:translateY(-2px)}

  .panel{background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.03);padding:14px;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  .panel-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:980px){.panel-grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border-radius:10px;padding:12px;border:1px solid var(--field-border)}
  .card h3{margin:0 0 8px 0;color:var(--neon);font-family:Orbitron;font-size:13px}
  label{font-size:13px;color:#bfc5cf;min-width:120px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:8px 10px;background:var(--input);border-radius:7px;border:1px solid rgba(0,0,0,0.3);color:var(--muted);outline:none;font-size:13px;
  }
  input:focus, textarea:focus, select:focus{box-shadow:var(--accent-glow);border-color:var(--neon);color:#fff;background:#1f1f20}
  textarea{min-height:80px;resize:vertical}

  .attributes{display:flex;gap:10px;flex-wrap:wrap}
  .attr-box{width:82px;background:linear-gradient(180deg,rgba(0,0,0,0.12),transparent);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--field-border)}
  .attr-box .score{font-size:18px;color:#fff;font-weight:700}
  .attr-box .label{font-size:12px;color:#c6cad2;margin-top:6px}
  .save-row{font-size:12px;color:#c6cad2;margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px}

  .skill-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .skill-row label{min-width:160px;color:#c6cad2}
  .checkbox-inline{display:flex;align-items:center;gap:6px;color:#bfc4cf;font-size:13px}
  .skill-bonus{min-width:48px;text-align:right;font-weight:700;color:#fff}

  .list-wrap{max-height:260px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(155,48,255,0.04);background:rgba(255,255,255,0.005)}
  .list-item{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
  .list-item input, .list-item textarea{background:#1a1b1d}
  .list-item .remove{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:4px 8px;border-radius:6px;cursor:pointer}

  .btnbar{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--neon),#5b0fbf);color:white;box-shadow:var(--accent-glow);border:none}
  .muted{color:#9aa0b5;font-size:12px}

  /* dice button */
  .d20-btn { display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:6px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.03);
    cursor:pointer; box-shadow: 0 0 8px rgba(155,48,255,0.06); position:relative; overflow:visible;
  }
  .d20-btn svg { width:16px; height:16px; display:block; filter: drop-shadow(0 0 6px rgba(155,48,255,0.12)); }
  .d20-btn .pulse { position:absolute; width:44px; height:44px; border-radius:6px; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; opacity:0; }
  .d20-btn.pulse-on .pulse { animation: ripple 480ms ease-out; opacity:1; }
  @keyframes ripple {
    0% { transform:translate(-50%,-50%) scale(.7); opacity:.6; box-shadow:0 0 6px rgba(155,48,255,0.22) }
    100%{ transform:translate(-50%,-50%) scale(1.6); opacity:0; }
  }

  /* roll log overlay */
  .roll-log-toggle { position:fixed; right:18px; bottom:18px; z-index:9999; display:flex; gap:8px; align-items:center; cursor:pointer; }
  .roll-log-toggle .hex { width:36px;height:36px;background:linear-gradient(135deg,var(--neon),#5b0fbf); border-radius:8px;display:flex;align-items:center;justify-content:center;box-shadow:var(--accent-glow) }
  .roll-log { position:fixed; right:18px; bottom:68px; width:320px; max-height:420px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.5)); border:1px solid rgba(155,48,255,0.12); box-shadow:0 12px 40px rgba(0,0,0,0.6); border-radius:8px; padding:10px; z-index:9998; display:none;}
  .roll-log h4{margin:0 0 8px 0;color:var(--neon); font-family:Orbitron; font-size:13px}
  .roll-entry{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;color:#e8e8e8}
  .roll-entry .meta{font-size:12px;color:#b8b8c1;margin-top:4px}
  .roll-controls{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

  /* snapshot */
  .snapshot .portrait{width:80px;height:80px;border-radius:8px;background:#0c0c0d;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .snapshot .portrait img{width:100%;height:100%;object-fit:cover}

  /* attacks table */
  .attacks-list{display:flex;flex-direction:column;gap:8px}
  .attack-row{display:flex;align-items:center;gap:8px;border-radius:6px;padding:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(155,48,255,0.03)}
  .attack-row .attack-name{flex:1}
  .attack-row .attack-meta{display:flex;gap:8px;align-items:center}
  .attack-row input[type="text"]{width:130px}

  /* small helpers */
  .muted-sm{font-size:12px;color:#9aa0b5}
  .inline { display:inline-flex; align-items:center; gap:8px; }
  .tiny { font-size:12px; color:#bfc5cf; }
  .pill { padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); }

  @media print{
    body{background:white;color:black}
    .titlebar, .tabs, .btnbar, .roll-log-toggle, .roll-log{display:none}
    input,textarea{border:1px solid #aaa;color:black;background:white}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <div class="logo">CV</div>
      <div class="title-text">
        <h1>Cybercraft 5e</h1>
        <p>Interactive Character Sheet</p>
      </div>

      <div class="controls">
        <button id="export" class="small">Export</button>
        <button id="importBtn" class="small">Import</button>
        <button id="clear" class="small">Clear</button>
        <button id="print" class="small primary">Print</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="core">Core</div>
      <div class="tab" data-tab="feats">Feats & Cyberware</div>
      <div class="tab" data-tab="abilities">Abilities & Spells</div>
      <div class="tab" data-tab="eq">EQ & Notes</div>
      <div class="tab" data-tab="combat" style="margin-left:auto">Combat Interface</div>
    </div>

    <div class="panel">
      <div class="panel-grid">

        <!-- LEFT MAIN -->
        <div>
          <!-- CORE TAB -->
          <div class="tab-panel" id="tab-core">
            <div class="card">
              <h3>Identity</h3>
              <div class="row"><label>Character Name</label><input id="name" type="text"></div>
              <div class="row"><label>Portrait URL</label><input id="portrait" type="text" placeholder="https://... (optional)"></div>
              <div class="row"><label>Player</label><input id="player" type="text"></div>
              <div class="row"><label>Race</label><input id="race" type="text"></div>
              <div class="row"><label>Class</label><input id="class_text" type="text"></div>
              <div class="row"><label>Level</label><input id="level" type="number" min="1" value="1"></div>
              <div class="row"><label>Background</label><input id="background" type="text"></div>
              <div class="row"><label>Faction</label><input id="faction" type="text"></div>
              <div class="row"><label>Webhook URL</label><input id="webhook" type="text" placeholder="Discord webhook (optional)"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attributes & Saving Throws</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="attr-box">
                  <div><input id="attr_STR" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">STR</div>
                  <div class="save-row"><input id="save_prof_STR" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_STR">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_DEX" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">DEX</div>
                  <div class="save-row"><input id="save_prof_DEX" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_DEX">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CON" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">CON</div>
                  <div class="save-row"><input id="save_prof_CON" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CON">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_INT" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">INT</div>
                  <div class="save-row"><input id="save_prof_INT" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_INT">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_WIS" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">WIS</div>
                  <div class="save-row"><input id="save_prof_WIS" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_WIS">+0</div></div>
                </div>

                <div class="attr-box">
                  <div><input id="attr_CHA" type="number" style="width:60px;text-align:center;background:transparent;border:none;color:#fff;font-size:18px;font-weight:700" value="10"/></div>
                  <div class="label">CHA</div>
                  <div class="save-row"><input id="save_prof_CHA" type="checkbox"/> <span style="font-size:12px;color:#c6cad2">Save Prof</span> <div style="margin-left:6px;font-weight:700;color:#fff" id="save_bonus_CHA">+0</div></div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Skills</h3>
              <p class="muted">Proficiency / Expertise — click the d20 to roll.</p>
              <div style="margin-top:8px">
                <!-- skills: each row includes roll button -->
                <div class="skill-row"><label>Athletics (STR)</label><div class="checkbox-inline"><input id="prof_athletics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_athletics" type="checkbox">Expertise</div><div class="skill-bonus" id="bonus_athletics">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Athletics" data-key="athletics" title="Roll Athletics"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Acrobatics (DEX)</label><div class="checkbox-inline"><input id="prof_acrobatics" type="checkbox">Prof</div><div class="checkbox-inline"><input id="exp_acrobatics" type="checkbox">Expertise</div><div class="skill-bonus" id="bonus_acrobatics">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Acrobatics" data-key="acrobatics" title="Roll Acrobatics"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Sleight of Hand (DEX)</label><div class="checkbox-inline"><input id="prof_sleight" type="checkbox"></div><div class="checkbox-inline"><input id="exp_sleight" type="checkbox"></div><div class="skill-bonus" id="bonus_sleight">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Sleight of Hand" data-key="sleight" title="Roll Sleight of Hand"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Stealth (DEX)</label><div class="checkbox-inline"><input id="prof_stealth" type="checkbox"></div><div class="checkbox-inline"><input id="exp_stealth" type="checkbox"></div><div class="skill-bonus" id="bonus_stealth">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Stealth" data-key="stealth" title="Roll Stealth"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Driving (DEX)</label><div class="checkbox-inline"><input id="prof_driving" type="checkbox"></div><div class="checkbox-inline"><input id="exp_driving" type="checkbox"></div><div class="skill-bonus" id="bonus_driving">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Driving" data-key="driving" title="Roll Driving"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Arcana (INT)</label><div class="checkbox-inline"><input id="prof_arcana" type="checkbox"></div><div class="checkbox-inline"><input id="exp_arcana" type="checkbox"></div><div class="skill-bonus" id="bonus_arcana">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Arcana" data-key="arcana" title="Roll Arcana"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Investigation (INT)</label><div class="checkbox-inline"><input id="prof_investigation" type="checkbox"></div><div class="checkbox-inline"><input id="exp_investigation" type="checkbox"></div><div class="skill-bonus" id="bonus_investigation">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Investigation" data-key="investigation" title="Roll Investigation"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Technology (INT)</label><div class="checkbox-inline"><input id="prof_technology" type="checkbox"></div><div class="checkbox-inline"><input id="exp_technology" type="checkbox"></div><div class="skill-bonus" id="bonus_technology">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Technology" data-key="technology" title="Roll Technology"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Perception (WIS)</label><div class="checkbox-inline"><input id="prof_perception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_perception" type="checkbox"></div><div class="skill-bonus" id="bonus_perception">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Perception" data-key="perception" title="Roll Perception"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

                <div class="skill-row"><label>Deception (CHA)</label><div class="checkbox-inline"><input id="prof_deception" type="checkbox"></div><div class="checkbox-inline"><input id="exp_deception" type="checkbox"></div><div class="skill-bonus" id="bonus_deception">+0</div><button class="d20-btn small-roll" data-rolltype="skill" data-skill="Deception" data-key="deception" title="Roll Deception"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>

              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Sanity & Corruption</h3>
              <div class="row" style="gap:12px">
                <label>Sanity (cur / max)</label>
                <input id="sanity_cur" type="number" style="width:80px" placeholder="cur">
                <input id="sanity_max" type="number" style="width:80px" placeholder="max">
              </div>
              <div class="row" style="gap:12px">
                <label>Corruption (cur / max)</label>
                <input id="corr_cur" type="number" style="width:80px" placeholder="cur">
                <input id="corr_max" type="number" style="width:80px" placeholder="max">
              </div>
              <div style="margin-top:8px"><label>Notes</label><textarea id="sanity_notes" placeholder="Sanity scars, mutations, notes..."></textarea></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>HP & Combat Basics</h3>
              <div style="display:flex;gap:8px;align-items:center">
                <label>HP</label>
                <input id="hp_max" type="number" placeholder="Max" style="width:90px">
                <input id="hp_cur" type="number" placeholder="Current" style="width:90px">
                <input id="hp_temp" type="number" placeholder="Temp" style="width:90px">
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label>AC</label><input id="ac" type="text" style="width:90px">
                <label style="margin-left:8px">Speed</label><input id="speed" type="text" style="width:90px">
                <label style="margin-left:8px">Proficiency</label><input id="prof_display" type="text" readonly style="width:80px">
                <label style="margin-left:8px">Initiative</label><input id="init" type="text" readonly style="width:70px">
                <button class="d20-btn" id="roll-init" title="Roll Initiative"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button>
              </div>
            </div>
          </div>

          <!-- FEATS & CYBERWARE TAB -->
          <div class="tab-panel" id="tab-feats" style="display:none">
            <div class="card">
              <h3>-- Feats --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_feat_name" placeholder="Feat name"/>
                <button id="addFeat">Add</button>
              </div>
              <div class="list-wrap" id="feats_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>-- Cyberware --</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_cyber_name" placeholder="Cyberware name"/>
                <button id="addCyber">Add</button>
              </div>
              <div class="list-wrap" id="cyber_list"></div>
            </div>
          </div>

          <!-- ABILITIES & SPELLS TAB -->
          <div class="tab-panel" id="tab-abilities" style="display:none">
            <div class="card">
              <h3>Abilities</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_ability_name" placeholder="Ability name"/>
                <button id="addAbility">Add</button>
              </div>
              <div class="list-wrap" id="abilities_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Spells</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_spell_name" placeholder="Spell name"/>
                <input id="new_spell_level" style="width:70px" placeholder="Lvl"/>
                <button id="addSpell">Add</button>
              </div>
              <div class="list-wrap" id="spells_list"></div>
            </div>
          </div>

          <!-- EQ & NOTES TAB -->
          <div class="tab-panel" id="tab-eq" style="display:none">
            <div class="card">
              <h3>Equipment</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_equip" placeholder="Item name (single-line)"/>
                <button id="addEquip">Add</button>
              </div>
              <div class="list-wrap" id="equip_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Vehicles</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input id="new_vehicle_name" placeholder="Vehicle name"/>
                <button id="addVehicle">Add</button>
              </div>
              <div class="list-wrap" id="vehicles_list"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Notes</h3>
              <textarea id="notes" placeholder="General notes, campaign hooks, NPCs..."></textarea>
            </div>
          </div>

        </div>

        <!-- RIGHT: snapshot & quick -->
        <div>
          <div class="card snapshot">
            <h3>Snapshot</h3>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="portrait" id="snapshot_portrait"><img src="" alt="" style="display:none"></div>
              <div style="flex:1">
                <div class="row"><strong>Name</strong><div id="snap_name" class="muted">—</div></div>
                <div class="row"><strong>Class / Level</strong><div id="snap_class" class="muted">—</div></div>
                <div class="row"><strong>HP</strong><div id="snap_hp" class="muted">0 / 0</div></div>
                <div class="row"><strong>AC</strong><div id="snap_ac" class="muted">—</div></div>
                <div class="row"><strong>Sanity / Corr.</strong><div id="snap_sanity" class="muted">—</div></div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Attack Manager</h3>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <input id="atk_name" placeholder="Attack name" style="flex:1">
              <input id="atk_bonus" placeholder="+atk" style="width:80px">
              <input id="atk_damage" placeholder="1d8+2 slashing" style="width:160px">
              <button id="addAttack">Add</button>
            </div>
            <div id="attacks_container" class="attacks-list"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Quick Tools</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="downloadJSON">Download JSON</button>
              <button id="loadJSON">Load JSON</button>
              <button id="clearLocal">Clear Local</button>
            </div>
            <p class="muted" style="margin-top:10px">Autosaves locally. Webhook optional — leave blank to disable.</p>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- Roll Log toggle & panel -->
  <div class="roll-log-toggle" id="rollToggle">
    <div class="hex" title="Toggle Roll Log">
      <!-- hexagon tiny -->
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="white" d="M12 2 L20 7 L20 17 L12 22 L4 17 L4 7 Z" opacity="0.95"/></svg>
    </div>
    <div class="tiny" style="color:var(--neon)">Roll Log</div>
  </div>
  <div class="roll-log" id="rollLog">
    <h4><svg style="vertical-align:middle;margin-right:8px" width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg> Recent Rolls</h4>
    <div id="roll_entries"></div>
    <div class="roll-controls"><button id="clearRolls">Clear</button><button id="collapseRolls">Collapse</button></div>
  </div>

<script>
/* ===============================
   Utilities / Constants
   =============================== */
const STORAGE_KEY = 'cybercraft_sheet_v_final';
const SKILLS = {
  athletics:'STR', acrobatics:'DEX', sleight:'DEX', stealth:'DEX', driving:'DEX',
  arcana:'INT', investigation:'INT', technology:'INT',
  perception:'WIS', deception:'CHA'
};
function abilityMod(score){ const s=parseInt(score)||10; return Math.floor((s-10)/2); }
function proficiencyByLevel(lvl){ lvl = Math.max(1, parseInt(lvl)||1); return Math.ceil(lvl/4)+1; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function d20(){ return Math.floor(Math.random()*20)+1; }

/* parse simple damage expression like "2d6+3 / fire" or "1d8+2 slashing" */
function rollExpression(expr){
  expr = (expr||'').trim();
  if(!expr) return {total:0,breakdown:'0'};
  // split off after first space as note
  const parts = expr.split(/\s+(.+)/);
  const dicePart = parts[0];
  const note = parts[1] ? parts[1] : '';
  // handle multiple damage groups separated by comma
  const groups = dicePart.split(',');
  let total = 0;
  let details = [];
  groups.forEach(g=>{
    g = g.trim();
    // match NdM+K or NdM-K or K
    const m = g.match(/(\d*)d(\d+)([+-]\d+)?/i);
    if(m){
      const n = parseInt(m[1]||1);
      const s = parseInt(m[2]);
      const k = parseInt(m[3]||0);
      let rolls = [];
      for(let i=0;i<n;i++){ rolls.push(Math.floor(Math.random()*s)+1); }
      const sum = rolls.reduce((a,b)=>a+b,0)+k;
      total += sum;
      details.push(`${n}d${s} [${rolls.join(',')}]${k? (k>0?('+'+k):k):''} = ${sum}`);
    } else {
      // maybe just a flat number
      const v = parseInt(g)||0;
      total += v;
      details.push(`${v}`);
    }
  });
  let breakdown = details.join(' ; ');
  if(note) breakdown += ` — ${note}`;
  return {total, breakdown};
}

/* send discord webhook embed if provided */
async function sendWebhook(payload){
  const url = document.getElementById('webhook').value.trim();
  if(!url) return; // disabled
  try{
    await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  }catch(e){
    console.warn('Webhook failed', e);
  }
}

/* build embed object per spec (neon violet color) */
function makeEmbed(title, rollLabel, resultStr, details, type){
  // color decimal for #9B30FF = 10170623
  const colorVal = 10170623;
  const charName = (document.getElementById('name').value||'Unnamed');
  const portrait = (document.getElementById('portrait').value||'').trim() || null;
  const embed = {
    embeds: [{
      author: { name: `${charName} — ${title}` },
      color: colorVal,
      fields: [
        { name: 'Roll', value: rollLabel, inline: true },
        { name: 'Result', value: `**${resultStr}**`, inline: true },
      ],
      timestamp: new Date().toISOString(),
      footer: { text: 'Cybercraft 5e' }
    }]
  };
  if(details) embed.embeds[0].description = details;
  if(portrait) embed.embeds[0].author.icon_url = portrait;
  return embed;
}

/* add entry to local roll log UI */
function pushRollLog(entry){
  const wrap = document.getElementById('roll_entries');
  const el = document.createElement('div');
  el.className = 'roll-entry';
  el.innerHTML = `<strong>${entry.title}</strong> — <span style="color:#fff">${entry.result}</span><div class="meta">${entry.meta}</div>`;
  wrap.insertBefore(el, wrap.firstChild);
  // keep only last 50
  const children = Array.from(wrap.children);
  if(children.length>50) children.slice(50).forEach(c=>c.remove());
}

/* ===============================
   Tab handling
   =============================== */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
    const id = 'tab-' + tab.dataset.tab;
    const panel = document.getElementById(id);
    if(panel) panel.style.display = 'block';
  });
});

/* ===============================
   Dynamic lists: feats, cyber, abilities, spells, equip, vehicles
   (similar to previous version)
   =============================== */
function renderList(containerId, items, templateFn){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  items.forEach((it,i)=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = templateFn(it,i);
    wrap.appendChild(el);
  });
}

/* Feats */
window._feats = window._feats || [];
function renderFeats(){ renderList('feats_list', window._feats, (f,i)=>`
  <div style="flex:1">
    <input class="feat_name" data-i="${i}" value="${escapeHtml(f.name||'')}" placeholder="Feat name"/>
    <textarea class="feat_desc" data-i="${i}" placeholder="Description">${escapeHtml(f.desc||'')}</textarea>
  </div>
  <div><button class="remove_feat" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addFeat').addEventListener('click', ()=>{
  const name = document.getElementById('new_feat_name').value.trim(); if(!name) return alert('Enter feat name');
  window._feats.push({name:name,desc:''}); document.getElementById('new_feat_name').value=''; renderFeats(); saveToStorage();
});
document.getElementById('feats_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_feat')){ const i=parseInt(e.target.dataset.i); window._feats.splice(i,1); renderFeats(); saveToStorage(); }
});
document.getElementById('feats_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('feat_name')) window._feats[i].name = e.target.value;
  if(cls.includes('feat_desc')) window._feats[i].desc = e.target.value;
  saveToStorage();
});

/* Cyberware */
window._cyber = window._cyber || [];
function renderCyber(){ renderList('cyber_list', window._cyber, (c,i)=>`
  <div style="flex:1">
    <input class="cyber_name" data-i="${i}" value="${escapeHtml(c.name||'')}" placeholder="Cyberware name"/>
    <textarea class="cyber_desc" data-i="${i}" placeholder="Description (optional)">${escapeHtml(c.desc||'')}</textarea>
  </div>
  <div><button class="remove_cyber" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addCyber').addEventListener('click', ()=>{
  const name=document.getElementById('new_cyber_name').value.trim(); if(!name) return alert('Enter cyberware name');
  window._cyber.push({name:name,desc:''}); document.getElementById('new_cyber_name').value=''; renderCyber(); saveToStorage();
});
document.getElementById('cyber_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_cyber')){ const i=parseInt(e.target.dataset.i); window._cyber.splice(i,1); renderCyber(); saveToStorage(); }
});
document.getElementById('cyber_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('cyber_name')) window._cyber[i].name = e.target.value;
  if(cls.includes('cyber_desc')) window._cyber[i].desc = e.target.value;
  saveToStorage();
});

/* Abilities */
window._abilities = window._abilities || [];
function renderAbilities(){ renderList('abilities_list', window._abilities, (a,i)=>`
  <div style="flex:1">
    <input class="ability_name" data-i="${i}" value="${escapeHtml(a.name||'')}" placeholder="Ability name"/>
    <textarea class="ability_desc" data-i="${i}" placeholder="Description">${escapeHtml(a.desc||'')}</textarea>
  </div>
  <div><button class="remove_ability" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addAbility').addEventListener('click', ()=>{
  const name=document.getElementById('new_ability_name').value.trim(); if(!name) return alert('Enter ability name');
  window._abilities.push({name:name,desc:''}); document.getElementById('new_ability_name').value=''; renderAbilities(); saveToStorage();
});
document.getElementById('abilities_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_ability')){ const i=parseInt(e.target.dataset.i); window._abilities.splice(i,1); renderAbilities(); saveToStorage(); }
});
document.getElementById('abilities_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('ability_name')) window._abilities[i].name = e.target.value;
  if(cls.includes('ability_desc')) window._abilities[i].desc = e.target.value;
  saveToStorage();
});

/* Spells */
window._spells = window._spells || [];
function renderSpells(){ renderList('spells_list', window._spells, (s,i)=>`
  <div style="flex:1">
    <input class="spell_name" data-i="${i}" value="${escapeHtml(s.name||'')}" placeholder="Spell name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="spell_level" data-i="${i}" style="width:70px" value="${escapeHtml(s.level||'')}" placeholder="Level"/>
      <input class="spell_time" data-i="${i}" style="flex:1" value="${escapeHtml(s.time||'')}" placeholder="Casting time / Range / Duration"/>
    </div>
    <textarea class="spell_desc" data-i="${i}" placeholder="Details">${escapeHtml(s.desc||'')}</textarea>
  </div>
  <div><button class="remove_spell" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addSpell').addEventListener('click', ()=>{
  const name=document.getElementById('new_spell_name').value.trim(); const lvl=document.getElementById('new_spell_level').value.trim();
  if(!name) return alert('Enter spell name');
  window._spells.push({name:name,level:lvl,time:'',desc:''}); document.getElementById('new_spell_name').value=''; document.getElementById('new_spell_level').value=''; renderSpells(); saveToStorage();
});
document.getElementById('spells_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_spell')){ const i=parseInt(e.target.dataset.i); window._spells.splice(i,1); renderSpells(); saveToStorage(); }
});
document.getElementById('spells_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('spell_name')) window._spells[i].name = e.target.value;
  if(cls.includes('spell_level')) window._spells[i].level = e.target.value;
  if(cls.includes('spell_time')) window._spells[i].time = e.target.value;
  if(cls.includes('spell_desc')) window._spells[i].desc = e.target.value;
  saveToStorage();
});

/* Equipment (single-line) */
window._equip = window._equip || [];
function renderEquip(){ renderList('equip_list', window._equip, (it,i)=>`
  <div style="flex:1">
    <input class="equip_item" data-i="${i}" value="${escapeHtml(it||'')}" placeholder="Item name"/>
  </div>
  <div><button class="remove_equip" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addEquip').addEventListener('click', ()=>{
  const name=document.getElementById('new_equip').value.trim(); if(!name) return alert('Enter item'); window._equip.push(name); document.getElementById('new_equip').value=''; renderEquip(); saveToStorage();
});
document.getElementById('equip_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_equip')){ const i=parseInt(e.target.dataset.i); window._equip.splice(i,1); renderEquip(); saveToStorage(); }
});
document.getElementById('equip_list').addEventListener('input',(e)=>{
  if(e.target.classList.contains('equip_item')){ const i=parseInt(e.target.dataset.i); window._equip[i] = e.target.value; saveToStorage(); }
});

/* Vehicles */
window._vehicles = window._vehicles || [];
function renderVehicles(){ renderList('vehicles_list', window._vehicles, (v,i)=>`
  <div style="flex:1">
    <input class="veh_name" data-i="${i}" value="${escapeHtml(v.name||'')}" placeholder="Vehicle name"/>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input class="veh_type" data-i="${i}" style="width:120px" value="${escapeHtml(v.type||'')}" placeholder="Type"/>
      <input class="veh_speed" data-i="${i}" style="width:100px" value="${escapeHtml(v.speed||'')}" placeholder="Speed"/>
      <input class="veh_ac" data-i="${i}" style="width:80px" value="${escapeHtml(v.ac||'')}" placeholder="AC"/>
    </div>
    <textarea class="veh_desc" data-i="${i}" placeholder="Upgrades / Notes">${escapeHtml(v.desc||'')}</textarea>
  </div>
  <div><button class="remove_vehicle" data-i="${i}">Remove</button></div>
`); }
document.getElementById('addVehicle').addEventListener('click', ()=>{
  const name=document.getElementById('new_vehicle_name').value.trim(); if(!name) return alert('Enter vehicle name');
  window._vehicles.push({name:name,type:'',speed:'',ac:'',desc:''}); document.getElementById('new_vehicle_name').value=''; renderVehicles(); saveToStorage();
});
document.getElementById('vehicles_list').addEventListener('click',(e)=>{
  if(e.target.classList.contains('remove_vehicle')){ const i=parseInt(e.target.dataset.i); window._vehicles.splice(i,1); renderVehicles(); saveToStorage(); }
});
document.getElementById('vehicles_list').addEventListener('input',(e)=>{
  const cls=e.target.className; const i=parseInt(e.target.dataset.i);
  if(cls.includes('veh_name')) window._vehicles[i].name = e.target.value;
  if(cls.includes('veh_type')) window._vehicles[i].type = e.target.value;
  if(cls.includes('veh_speed')) window._vehicles[i].speed = e.target.value;
  if(cls.includes('veh_ac')) window._vehicles[i].ac = e.target.value;
  if(cls.includes('veh_desc')) window._vehicles[i].desc = e.target.value;
  saveToStorage();
});

/* ===============================
   Attacks manager
   =============================== */
window._attacks = window._attacks || [];
function renderAttacks(){
  const wrap = document.getElementById('attacks_container');
  wrap.innerHTML = '';
  window._attacks.forEach((a,i)=>{
    const row = document.createElement('div'); row.className='attack-row';
    row.innerHTML = `
      <div class="attack-name"><strong>${escapeHtml(a.name)}</strong><div class="muted-sm">${escapeHtml(a.damage)}</div></div>
      <div class="attack-meta">
        <div class="pill">${escapeHtml(a.bonus)}</div>
        <button class="d20-btn atk-roll" data-i="${i}" data-type="attack" title="Roll Attack"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button>
        <button class="d20-btn dmg-roll" data-i="${i}" data-type="damage" title="Roll Damage"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button>
        <button class="remove_attack" data-i="${i}">Remove</button>
      </div>
    `;
    wrap.appendChild(row);
  });
}
document.getElementById('addAttack').addEventListener('click', ()=>{
  const name = document.getElementById('atk_name').value.trim();
  const bonus = document.getElementById('atk_bonus').value.trim();
  const dmg = document.getElementById('atk_damage').value.trim();
  if(!name) return alert('Enter attack name');
  window._attacks.push({name, bonus:bonus||'+0', damage:dmg||''});
  document.getElementById('atk_name').value=''; document.getElementById('atk_bonus').value=''; document.getElementById('atk_damage').value='';
  renderAttacks(); saveToStorage();
});
document.getElementById('attacks_container').addEventListener('click',(e)=>{
  if(e.target.closest('.remove_attack')){ const i=parseInt(e.target.closest('.remove_attack').dataset.i); window._attacks.splice(i,1); renderAttacks(); saveToStorage(); return; }
  const atkBtn = e.target.closest('.atk-roll');
  const dmgBtn = e.target.closest('.dmg-roll');
  if(atkBtn){
    const i=parseInt(atkBtn.dataset.i);
    rollAttack(i);
  } else if(dmgBtn){
    const i=parseInt(dmgBtn.dataset.i);
    rollDamage(i);
  }
});

/* roll attack */
function rollAttack(index){
  const atk = window._attacks[index];
  const d = d20();
  // parse bonus like +5 or 5
  const b = parseInt((atk.bonus||'').replace('+',''))||0;
  const total = d + b;
  const title = 'Attack';
  const rollLabel = `${atk.name} (Attack)`;
  const resultStr = `${total} (d20 ${d} + ${b})`;
  pushRollLog({title:rollLabel, result:resultStr, meta:`Type: Attack`});
  // send webhook embed
  const embed = makeEmbed('Attack', rollLabel, resultStr, atk.damage ? `Damage: ${atk.damage}` : '', 'attack');
  sendWebhook(embed);
}

/* roll damage */
function rollDamage(index){
  const atk = window._attacks[index];
  const res = rollExpression(atk.damage);
  const title = 'Damage';
  const rollLabel = `${atk.name} — ${atk.damage || '—'}`;
  const resultStr = `${res.total}`;
  const details = res.breakdown;
  pushRollLog({title:rollLabel, result:resultStr, meta:details});
  const embed = makeEmbed('Damage', rollLabel, resultStr, details, 'damage');
  sendWebhook(embed);
}

/* ===============================
   Roll handlers for initiative, skills, saves
   =============================== */
function doSkillRoll(key, label){
  // determine ability and mod
  const prof = document.getElementById('prof_' + key) ? document.getElementById('prof_' + key).checked : false;
  const exp = document.getElementById('exp_' + key) ? document.getElementById('exp_' + key).checked : false;
  const ab = SKILLS[key];
  const score = parseInt(document.getElementById('attr_' + ab).value)||10;
  const abmod = abilityMod(score);
  let profVal = proficiencyByLevel(parseInt(document.getElementById('level').value)||1);
  let bonus = abmod + (prof ? profVal * (exp ? 2 : 1) : 0);
  const roll = d20();
  const total = roll + bonus;
  const title = 'Skill Check';
  const rollLabel = `${label} (${ab})`;
  const resultStr = `${total} (d20 ${roll} + ${bonus})`;
  pushRollLog({title:rollLabel, result:resultStr, meta:`Ability mod ${abmod}, Prof ${prof?profVal:0}${exp?' (expert)':''}`});
  const embed = makeEmbed('Skill Check', rollLabel, resultStr, `Detail: d20 ${roll} + ${bonus}`, 'skill');
  sendWebhook(embed);
}

function doSaveRoll(ab){
  const profChecked = document.getElementById('save_prof_' + ab).checked;
  const score = parseInt(document.getElementById('attr_' + ab).value)||10;
  const mod = abilityMod(score);
  const profVal = proficiencyByLevel(parseInt(document.getElementById('level').value)||1);
  const bonus = mod + (profChecked ? profVal : 0);
  const roll = d20();
  const total = roll + bonus;
  const title = 'Saving Throw';
  const rollLabel = `${ab} Save`;
  const resultStr = `${total} (d20 ${roll} + ${bonus})`;
  pushRollLog({title:rollLabel, result:resultStr, meta:`Ability mod ${mod}, Prof ${profChecked?profVal:0}`});
  const embed = makeEmbed('Saving Throw', rollLabel, resultStr, `Detail: d20 ${roll} + ${bonus}`, 'save');
  sendWebhook(embed);
}

/* initiative */
function rollInitiative(){
  const dex = parseInt(document.getElementById('attr_DEX').value)||10;
  const mod = abilityMod(dex);
  const roll = d20();
  const total = roll + mod;
  document.getElementById('init').value = (total>=0?'+':'')+total;
  pushRollLog({title:'Initiative', result:`${total} (d20 ${roll} + ${mod})`, meta:`DEX mod ${mod}`});
  const embed = makeEmbed('Initiative', 'Initiative Roll', `${total} (d20 ${roll} + ${mod})`, '', 'initiative');
  sendWebhook(embed);
}

/* button listeners for small skill d20 buttons */
document.addEventListener('click', (e)=>{
  const sk = e.target.closest('.small-roll');
  if(sk){
    const key = sk.dataset.key;
    const label = sk.dataset.skill;
    sk.classList.add('pulse-on');
    setTimeout(()=>sk.classList.remove('pulse-on'), 520);
    doSkillRoll(key, label);
  }
});

/* roll-init button */
document.getElementById('roll-init').addEventListener('click', (e)=>{
  e.currentTarget.classList.add('pulse-on'); setTimeout(()=>e.currentTarget.classList.remove('pulse-on'),520);
  rollInitiative();
});

/* attach save roll triggers - we'll create simple inline buttons under Combat Interface (see later) */

/* ===============================
   Save / Load / Snapshot / Calculations
   =============================== */
function gatherState(){
  const state = {};
  const ids = [
    'name','player','portrait','race','class_text','level','background','faction','webhook',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','init','speed','prof_display','hp_max','hp_cur','hp_temp',
    'sanity_cur','sanity_max','corr_cur','corr_max','sanity_notes','notes'
  ];
  ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; state[id] = (el.type==='checkbox') ? el.checked : el.value; });
  // skills prof/exp
  ['athletics','acrobatics','sleight','stealth','driving','arcana','investigation','technology','perception','deception'].forEach(s=>{
    const p = document.getElementById('prof_'+s), e = document.getElementById('exp_'+s);
    state['prof_'+s] = p ? p.checked : false; state['exp_'+s] = e ? e.checked : false;
  });
  state.feats = window._feats || []; state.cyber = window._cyber || []; state.abilities = window._abilities || []; state.spells = window._spells || [];
  state.equip = window._equip || []; state.vehicles = window._vehicles || [];
  state.attacks = window._attacks || [];
  return state;
}
function applyState(state){
  if(!state) return;
  const ids = [
    'name','player','portrait','race','class_text','level','background','faction','webhook',
    'attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'ac','init','speed','prof_display','hp_max','hp_cur','hp_temp',
    'sanity_cur','sanity_max','corr_cur','corr_max','sanity_notes','notes'
  ];
  ids.forEach(id=>{ const el=document.getElementById(id); if(!el || state[id]===undefined) return; if(el.type==='checkbox') el.checked = !!state[id]; else el.value = state[id]; });
  ['athletics','acrobatics','sleight','stealth','driving','arcana','investigation','technology','perception','deception'].forEach(s=>{
    const p=document.getElementById('prof_'+s); if(p) p.checked = !!state['prof_'+s];
    const e=document.getElementById('exp_'+s); if(e) e.checked = !!state['exp_'+s];
  });
  window._feats = state.feats||[]; window._cyber = state.cyber||[]; window._abilities = state.abilities||[]; window._spells = state.spells||[]; window._equip = state.equip||[]; window._vehicles = state.vehicles||[];
  window._attacks = state.attacks||[];
  renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
  updateAllCalculations(); updateSnapshot();
}
function saveToStorage(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(gatherState())); }catch(e){console.error(e);} }
function loadFromStorage(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; applyState(JSON.parse(raw)); }catch(e){console.error(e);} }

/* update prof/saves/skills/init */
function updateAllCalculations(){
  const level = parseInt(document.getElementById('level').value) || 1;
  const prof = proficiencyByLevel(level);
  document.getElementById('prof_display').value = (prof>=0?'+':'') + prof;

  ['STR','DEX','CON','INT','WIS','CHA'].forEach(ab=>{
    const score = parseInt(document.getElementById('attr_'+ab).value)||10;
    const mod = abilityMod(score);
    const profCheck = document.getElementById('save_prof_'+ab).checked;
    const total = mod + (profCheck ? prof : 0);
    document.getElementById('save_bonus_'+ab).textContent = (total>=0?'+':'') + total;
  });

  // skills
  const skillMap = {
    athletics:'athletics', acrobatics:'acrobatics', sleight:'sleight', stealth:'stealth', driving:'driving',
    arcana:'arcana', investigation:'investigation', technology:'technology', perception:'perception', deception:'deception'
  };
  Object.keys(skillMap).forEach(k=>{
    const key = skillMap[k];
    const ab = SKILLS[key];
    const score = parseInt(document.getElementById('attr_'+ab).value)||10;
    const abmod = abilityMod(score);
    const profCheck = document.getElementById('prof_'+key) ? document.getElementById('prof_'+key).checked : false;
    const expCheck = document.getElementById('exp_'+key) ? document.getElementById('exp_'+key).checked : false;
    let bonus = abmod;
    if(profCheck) bonus += prof * (expCheck ? 2 : 1);
    const el = document.getElementById('bonus_'+key);
    if(el) el.textContent = (bonus>=0?'+':'') + bonus;
  });

  // Initiative from DEX mod
  const dex = parseInt(document.getElementById('attr_DEX').value)||10;
  const imod = abilityMod(dex);
  document.getElementById('init').value = (imod>=0?'+':'') + imod;

  saveToStorage();
  updateSnapshot();
}

function updateSnapshot(){
  document.getElementById('snap_name').textContent = document.getElementById('name').value || '—';
  document.getElementById('snap_class').textContent = (document.getElementById('class_text').value||'—') + ' / ' + (document.getElementById('level').value||'—');
  document.getElementById('snap_hp').textContent = (document.getElementById('hp_cur').value||'0') + ' / ' + (document.getElementById('hp_max').value||'0') + (document.getElementById('hp_temp').value?(' (+'+document.getElementById('hp_temp').value+')'):'');
  document.getElementById('snap_ac').textContent = document.getElementById('ac').value || '—';
  document.getElementById('snap_sanity').textContent = (document.getElementById('sanity_cur').value||'—') + ' / ' + (document.getElementById('corr_cur').value||'—');
  const portrait = document.getElementById('portrait').value.trim();
  const imgWrap = document.getElementById('snapshot_portrait').querySelector('img');
  if(portrait){
    imgWrap.src = portrait; imgWrap.style.display='block';
  } else {
    imgWrap.style.display='none'; imgWrap.src='';
  }
}

/* attach listeners for inputs */
function attachListeners(){
  const watch = [
    'level','attr_STR','attr_DEX','attr_CON','attr_INT','attr_WIS','attr_CHA',
    'save_prof_STR','save_prof_DEX','save_prof_CON','save_prof_INT','save_prof_WIS','save_prof_CHA',
    'sanity_cur','sanity_max','corr_cur','corr_max','hp_cur','hp_max','hp_temp','ac','init','notes','portrait','webhook'
  ];
  watch.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(el.type==='checkbox') el.addEventListener('change', updateAllCalculations);
    else el.addEventListener('input', ()=>{ if(window._calcTimer) clearTimeout(window._calcTimer); window._calcTimer=setTimeout(()=>updateAllCalculations(),180);});
  });
  // skill prof/exp changes
  ['athletics','acrobatics','sleight','stealth','driving','arcana','investigation','technology','perception','deception'].forEach(s=>{
    const p = document.getElementById('prof_'+s); const e = document.getElementById('exp_'+s);
    if(p) p.addEventListener('change', updateAllCalculations);
    if(e) e.addEventListener('change', updateAllCalculations);
  });
  document.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', ()=>{
      if(window._saveTimer) clearTimeout(window._saveTimer);
      window._saveTimer = setTimeout(()=>saveToStorage(),420);
    });
  });
}

/* export/import/print/clear */
document.getElementById('export').addEventListener('click', ()=>{
  const raw = JSON.stringify(gatherState());
  const blob = new Blob([raw], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (document.getElementById('name').value||'character') + '.cyber.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = (e) => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed)); applyState(parsed); alert('Import OK'); }catch(err){ alert('Import failed: invalid file'); } }; r.readAsText(f); }; input.click();
});
document.getElementById('print').addEventListener('click', ()=>window.print());
document.getElementById('clear').addEventListener('click', ()=>{ if(confirm('Clear local sheet data? This cannot be undone.')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

document.getElementById('downloadJSON').addEventListener('click', ()=>document.getElementById('export').click && document.getElementById('export').click());
document.getElementById('loadJSON').addEventListener('click', ()=>document.getElementById('importBtn').click && document.getElementById('importBtn').click());
document.getElementById('clearLocal').addEventListener('click', ()=>document.getElementById('clear').click && document.getElementById('clear').click());

/* roll log UI toggle */
const rollToggle = document.getElementById('rollToggle');
const rollLog = document.getElementById('rollLog');
rollToggle.addEventListener('click', ()=>{
  if(rollLog.style.display === 'block'){ rollLog.style.display='none'; } else { rollLog.style.display='block'; }
});
document.getElementById('collapseRolls').addEventListener('click', ()=>{ rollLog.style.display='none'; });
document.getElementById('clearRolls').addEventListener('click', ()=>{ document.getElementById('roll_entries').innerHTML=''; });

/* small helper to escape for inputs */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* attach attack/skill buttons globally (d20 pulses) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.d20-btn');
  if(btn){
    btn.classList.add('pulse-on'); setTimeout(()=>btn.classList.remove('pulse-on'),520);
  }
});

/* generic handlers for save roll buttons placed under Combat Interface - create them in the Combat Interface UI */
function wireSaveButtons(){
  // We'll create a minimal save panel there (see below)
}

/* handle click for attacks/damage handled earlier */

/* ===============================
   Combat Interface tab: build save list and attach events
   =============================== */
function buildCombatInterface(){
  const panel = document.getElementById('tab-combat');
  if(!panel) return;
  // build a simple card with saves and resistances and roll buttons (streamlined)
  panel.innerHTML = `
    <div class="card">
      <h3>Saves</h3>
      <div id="saves_wrap"></div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Resistances & Status</h3>
      <div class="row"><label>Resistances</label><input id="resistances" placeholder="fire, cold, tech..."></div>
      <div class="row"><label>Immunities</label><input id="immunities" placeholder="—"></div>
      <div class="row"><label>Vulnerabilities</label><input id="vulns" placeholder="—"></div>
    </div>
  `;
  const wrap = panel.querySelector('#saves_wrap');
  ['STR','DEX','CON','INT','WIS','CHA'].forEach(ab=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.alignItems='center'; div.style.justifyContent='space-between'; div.style.marginBottom='8px';
    div.innerHTML = `<div class="inline"><div style="min-width:140px">${ab} Save</div><div id="save_display_${ab}" class="pill"></div></div><div class="inline"><button class="d20-btn save-roll" data-ab="${ab}" title="Roll ${ab} Save"><span class="pulse"></span><svg viewBox="0 0 24 24"><path fill="none" stroke="white" stroke-width="1.6" d="M12 2 L20 6 L20 18 L12 22 L4 18 L4 6 Z"/></svg></button></div>`;
    wrap.appendChild(div);
    // fill the save_display element with current total
    const prof = proficiencyByLevel(parseInt(document.getElementById('level').value)||1);
    const profChecked = document.getElementById('save_prof_'+ab).checked;
    const score = parseInt(document.getElementById('attr_'+ab).value)||10;
    const mod = abilityMod(score);
    const total = mod + (profChecked?prof:0);
    const el = document.getElementById('save_display_'+ab);
    if(el) el.textContent = (total>=0?'+':'') + total;
  });

  // wire save-roll buttons
  panel.querySelectorAll('.save-roll').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const ab = b.dataset.ab;
      b.classList.add('pulse-on'); setTimeout(()=>b.classList.remove('pulse-on'),520);
      doSaveRoll(ab);
    });
  });
}

/* ===============================
   Webhook embed send formats are done in makeEmbed/sendWebhook
   =============================== */

/* ===============================
   Boot
   =============================== */
attachListeners();
loadFromStorage();
renderFeats(); renderCyber(); renderAbilities(); renderSpells(); renderEquip(); renderVehicles(); renderAttacks();
setTimeout(()=>{ updateAllCalculations(); updateSnapshot(); buildCombatInterface(); },200);

/* wire general attack roll buttons inside attacks container handled earlier */

/* listen for clicks on skill d20's already set; add general click forwarding for other generated d20 buttons (attacks handled) */
document.addEventListener('click',(e)=>{
  // handle remove buttons for feats/cyber etc (they're already wired via event delegation)
});

/* small: clicking skill or save buttons handled above */
/* small helper to show webhook payload debug on error could be added later */

</script>
</body>
</html>
